<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YZ Exercise - ××—×•×œ×œ ××™××•× ×™×</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- MediaPipe (× ×˜×¢×Ÿ ×¨×§ ×›×©×¦×¨×™×š) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #FF6B35;
            --primary-dark: #E84A1C;
            --secondary: #004E89;
            --accent: #FFD23F;
            --dark: #1A1A2E;
            --light: #F8F9FA;
            --success: #06D6A0;
            --gradient: linear-gradient(135deg, #FF6B35 0%, #E84A1C 100%);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
            --radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Heebo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,107,53,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0,78,137,0.1) 0%, transparent 50%);
            pointer-events: none; z-index: 0;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }

        /* â”€â”€ HEADER â”€â”€ */
        header { text-align: center; padding: 40px 20px; margin-bottom: 40px; animation: fadeInDown 0.8s ease-out; }

        h1 {
            font-family: 'Rubik', sans-serif;
            font-size: clamp(2rem, 6vw, 4rem);
            font-weight: 900;
            background: linear-gradient(135deg, #fff 0%, #FFD23F 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            margin-bottom: 10px; letter-spacing: -1px;
        }
        .subtitle { color: rgba(255,255,255,0.9); font-size: clamp(1rem, 3vw, 1.3rem); font-weight: 300; }

        /* â”€â”€ NAV TABS â”€â”€ */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 18px;
        }
        .nav-tab {
            flex: 1;
            padding: 13px 10px;
            border: none;
            border-radius: 12px;
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            font-size: clamp(0.85rem, 2.5vw, 1rem);
            cursor: pointer;
            transition: var(--transition);
            background: transparent;
            color: rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .nav-tab.active {
            background: white;
            color: var(--primary);
            box-shadow: var(--shadow-md);
        }
        .nav-tab:not(.active):hover { background: rgba(255,255,255,0.15); color: white; }

        /* â”€â”€ PAGE SECTIONS â”€â”€ */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }

        /* â”€â”€ MAIN CONTENT (workout generator) â”€â”€ */
        .main-content { display: grid; grid-template-columns: 1fr; gap: 30px; margin-bottom: 40px; }
        @media (min-width: 768px) { .main-content { grid-template-columns: 300px 1fr; } }

        .settings-panel {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow-lg);
            animation: fadeInRight 0.8s ease-out;
            position: sticky; top: 20px; max-height: calc(100vh - 40px); overflow-y: auto;
        }
        .settings-panel h2 { font-family: 'Rubik', sans-serif; font-size: 1.8rem; color: var(--primary); margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        .setting-group { margin-bottom: 30px; }
        .setting-group h3 { font-size: 1.1rem; color: var(--secondary); margin-bottom: 15px; font-weight: 600; }
        .select-wrapper { position: relative; margin-bottom: 20px; }
        select {
            width: 100%; padding: 12px 16px; border: 2px solid var(--light); border-radius: 12px;
            font-size: 1rem; font-family: 'Heebo', sans-serif; background: white; cursor: pointer;
            transition: var(--transition); appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23FF6B35' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: left 16px center;
        }
        select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255,107,53,0.1); }

        .checkbox-group { display: flex; flex-direction: column; gap: 12px; }
        .checkbox-item { display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 10px; border-radius: 8px; transition: var(--transition); }
        .checkbox-item:hover { background: rgba(255,107,53,0.05); }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--primary); cursor: pointer; }
        .checkbox-item label { cursor: pointer; user-select: none; font-weight: 500; }

        .workout-area { animation: fadeInLeft 0.8s ease-out; }

        .action-buttons { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .btn {
            flex: 1; min-width: 200px; padding: 18px 32px; border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: 700; font-family: 'Rubik', sans-serif;
            cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center; gap: 10px;
            position: relative; overflow: hidden;
        }
        .btn::before {
            content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
            border-radius: 50%; background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
        }
        .btn:active::before { width: 300px; height: 300px; }
        .btn-primary { background: var(--gradient); color: white; box-shadow: var(--shadow-md); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-primary:active { transform: translateY(0); }
        .btn-secondary { background: white; color: var(--secondary); border: 2px solid var(--secondary); }
        .btn-secondary:hover { background: var(--secondary); color: white; }

        .loading { display: none; text-align: center; padding: 60px; }
        .loading.active { display: block; }
        .spinner { width: 60px; height: 60px; border: 5px solid rgba(255,107,53,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }

        .workout-container {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow-lg);
            margin-bottom: 30px; display: none;
        }
        .workout-container.active { display: block; animation: fadeIn 0.6s ease-out; }
        .workout-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .workout-header h2 { font-family: 'Rubik', sans-serif; color: var(--primary); font-size: 1.8rem; }
        .workout-stats { display: flex; gap: 15px; }
        .stat-badge { background: var(--gradient); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; }

        .workout-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 20px; }
        .workout-table thead tr { background: var(--secondary); color: white; }
        .workout-table thead th { padding: 15px; text-align: right; font-weight: 600; font-size: 1rem; border: none; }
        .workout-table thead th:first-child { border-radius: 12px 0 0 12px; }
        .workout-table thead th:last-child { border-radius: 0 12px 12px 0; }
        .workout-table tbody tr { background: white; box-shadow: var(--shadow-sm); transition: var(--transition); animation: slideUp 0.4s ease-out backwards; }
        .workout-table tbody tr:hover { transform: translateX(-5px); box-shadow: var(--shadow-md); }
        .workout-table tbody td { padding: 20px 15px; border: none; }
        .workout-table tbody tr td:first-child { border-radius: 12px 0 0 12px; }
        .workout-table tbody tr td:last-child { border-radius: 0 12px 12px 0; }

        .exercise-link {
            display: inline-flex; align-items: center; gap: 8px;
            color: var(--primary); text-decoration: none; font-weight: 600;
            padding: 8px 16px; border-radius: 8px; background: rgba(255,107,53,0.1); transition: var(--transition);
        }
        .exercise-link:hover { background: var(--primary); color: white; transform: scale(1.05); }

        /* â”€â”€ NEW: analyze button in table â”€â”€ */
        .analyze-btn {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--secondary); text-decoration: none; font-weight: 600;
            padding: 8px 14px; border-radius: 8px; background: rgba(0,78,137,0.08);
            border: none; cursor: pointer; font-family: 'Heebo', sans-serif; font-size: 0.9rem;
            transition: var(--transition);
        }
        .analyze-btn:hover { background: var(--secondary); color: white; transform: scale(1.05); }

        .difficulty-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }
        .difficulty-×§×œ { background: #D4EDDA; color: #155724; }
        .difficulty-×‘×™× ×•× ×™ { background: #FFF3CD; color: #856404; }
        .difficulty-×§×©×” { background: #F8D7DA; color: #721C24; }

        .timer-container {
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow-lg);
            margin-bottom: 30px; text-align: center; display: none;
        }
        .timer-container.active { display: block; animation: fadeIn 0.6s ease-out; }
        .timer-display { font-size: 4rem; font-weight: 900; color: var(--primary); margin: 20px 0; font-family: 'Rubik', sans-serif; }
        .timer-controls { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .timer-btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); }

        .history-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: var(--radius); padding: 30px; box-shadow: var(--shadow-lg); display: none; }
        .history-container.active { display: block; animation: fadeIn 0.6s ease-out; }
        .history-item { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow-sm); cursor: pointer; transition: var(--transition); }
        .history-item:hover { transform: translateX(-5px); box-shadow: var(--shadow-md); }
        .history-date { color: var(--secondary); font-weight: 600; margin-bottom: 10px; }

        .alert { padding: 16px 20px; border-radius: 12px; margin-bottom: 20px; display: none; align-items: center; gap: 12px; animation: slideDown 0.4s ease-out; }
        .alert.active { display: flex; }
        .alert-success { background: #D4EDDA; color: #155724; border: 2px solid #C3E6CB; }
        .alert-warning { background: #FFF3CD; color: #856404; border: 2px solid #FFEAA7; }
        .alert-error { background: #F8D7DA; color: #721C24; border: 2px solid #F5C6CB; }

        .export-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn-export { flex: 1; min-width: 150px; padding: 10px 20px; background: white; color: var(--secondary); border: 2px solid var(--secondary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); }
        .btn-export:hover { background: var(--secondary); color: white; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           POSE ANALYZER PAGE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .pose-page {
            background: rgba(255,255,255,0.95);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            min-height: 80vh;
        }

        /* inner layout */
        .pose-layout {
            display: grid;
            grid-template-columns: 1fr;
            min-height: 80vh;
        }
        @media (min-width: 768px) {
            .pose-layout { grid-template-columns: 1fr 320px; }
        }

        /* camera side */
        .pose-camera-col {
            position: relative;
            background: #0a0a0f;
            min-height: 420px;
            border-radius: var(--radius) 0 0 var(--radius);
            overflow: hidden;
        }

        #poseVideo {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            object-fit: contain;
            transform: scaleX(-1);
            background: #000;
        }
        #poseCanvas {
            position: absolute; inset: 0;
            width: 100%; height: 100%;
            object-fit: contain;
        }

        /* zoom controls */
        .pose-zoom-controls {
            position: absolute; top: 14px; right: 14px; z-index: 9;
            display: flex; flex-direction: column; gap: 6px;
        }
        .pose-zoom-btn {
            width: 36px; height: 36px; border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.18);
            background: rgba(10,10,15,0.75); color: #fff;
            font-size: 1.2rem; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(6px); transition: var(--transition); line-height: 1;
        }
        .pose-zoom-btn:active { transform: scale(0.88); background: rgba(255,107,53,0.3); }
        .pose-zoom-label {
            text-align: center; font-size: 0.7rem; color: rgba(255,255,255,0.5);
            font-family: 'Rubik', sans-serif; font-weight: 700;
        }

        /* start overlay inside camera */
        .pose-start-overlay {
            position: absolute; inset: 0; z-index: 10;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 20px;
            background: rgba(10,10,15,0.88); backdrop-filter: blur(6px);
            transition: opacity 0.4s;
            padding: 30px;
            text-align: center;
        }
        .pose-start-overlay.hidden { opacity: 0; pointer-events: none; }

        .pose-start-overlay .big-icon { font-size: 3.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

        .pose-ex-btns { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .pose-ex-btn {
            padding: 12px 22px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.15);
            background: rgba(255,255,255,0.08); color: #fff;
            font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 0.95rem;
            cursor: pointer; transition: var(--transition);
        }
        .pose-ex-btn.active, .pose-ex-btn:hover {
            border-color: var(--primary); background: rgba(255,107,53,0.2); color: var(--primary);
        }

        .pose-start-btn {
            padding: 16px 44px; border-radius: 14px; border: none;
            background: var(--gradient); color: #fff;
            font-family: 'Rubik', sans-serif; font-weight: 900; font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 4px 20px rgba(255,107,53,0.4);
            transition: var(--transition);
        }
        .pose-start-btn:active { transform: scale(0.96); }

        .pose-permission-hint { color: rgba(255,255,255,0.5); font-size: 0.8rem; max-width: 240px; line-height: 1.5; }

        /* loading overlay inside camera */
        .pose-loading-overlay {
            position: absolute; inset: 0; z-index: 20;
            display: none;
            flex-direction: column;
            align-items: center; justify-content: center; gap: 16px;
            background: rgba(10,10,15,0.92);
            transition: opacity 0.5s;
        }
        .pose-loading-overlay.visible {
            display: flex;
        }
        .pose-spinner { width: 48px; height: 48px; border: 4px solid rgba(255,107,53,0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.9s linear infinite; }
        .pose-loading-text { color: rgba(255,255,255,0.6); font-size: 0.9rem; text-align: center; }

        /* feedback pill on camera */
        .pose-feedback-pill {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            z-index: 8; white-space: nowrap;
            background: rgba(10,10,15,0.82); backdrop-filter: blur(8px);
            border: 1.5px solid rgba(255,255,255,0.12); border-radius: 40px;
            padding: 9px 20px;
            font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 0.9rem;
            color: rgba(255,255,255,0.8); pointer-events: none;
            transition: all 0.3s;
        }
        .pose-feedback-pill.good { border-color: #06d6a0; color: #06d6a0; }
        .pose-feedback-pill.warn { border-color: #ffd23f; color: #ffd23f; }
        .pose-feedback-pill.bad  { border-color: #ff4757; color: #ff4757; }

        /* flip button */
        .pose-flip-btn {
            position: absolute; top: 14px; left: 14px; z-index: 9;
            width: 38px; height: 38px; border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.18); background: rgba(10,10,15,0.7);
            color: #fff; font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(6px); transition: var(--transition);
        }
        .pose-flip-btn:active { transform: scale(0.9); }

        /* right panel */
        .pose-panel-col {
            padding: 28px 24px;
            display: flex; flex-direction: column; gap: 20px;
            background: rgba(255,255,255,0.97);
            border-radius: 0 var(--radius) var(--radius) 0;
        }

        .pose-panel-title {
            font-family: 'Rubik', sans-serif; font-weight: 900; font-size: 1.4rem; color: var(--primary);
        }

        /* rep counter */
        .pose-rep-box {
            text-align: center; padding: 20px;
            background: linear-gradient(135deg, rgba(255,107,53,0.08), rgba(232,74,28,0.04));
            border: 2px solid rgba(255,107,53,0.15); border-radius: 14px;
        }
        .pose-rep-num {
            font-family: 'Rubik', sans-serif; font-weight: 900; font-size: 4.5rem; line-height: 1;
            color: var(--primary);
            transition: transform 0.15s;
        }
        .pose-rep-num.flash { transform: scale(1.2); }
        .pose-rep-lbl { color: rgba(26,26,46,0.5); font-weight: 700; font-size: 0.9rem; margin-top: 4px; }

        /* metric cards */
        .pose-metrics { display: flex; flex-direction: column; gap: 10px; }

        .pose-metric-card {
            padding: 14px 16px; border-radius: 12px; border: 1.5px solid #eee;
            background: white; transition: border-color 0.3s, background 0.3s;
        }
        .pose-metric-card.good { border-color: #06d6a0; background: rgba(6,214,160,0.05); }
        .pose-metric-card.warn { border-color: #ffd23f; background: rgba(255,210,63,0.05); }
        .pose-metric-card.bad  { border-color: #ff4757; background: rgba(255,71,87,0.05); }

        .pose-metric-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .pose-metric-name { font-weight: 700; font-size: 0.85rem; color: var(--dark); }
        .pose-metric-val { font-family: 'Rubik', sans-serif; font-weight: 900; font-size: 1.2rem; color: var(--dark); }

        .pose-bar-wrap { height: 5px; background: rgba(0,0,0,0.07); border-radius: 3px; overflow: hidden; }
        .pose-bar { height: 100%; border-radius: 3px; transition: width 0.3s, background 0.3s; }

        /* controls */
        .pose-controls { display: flex; gap: 10px; margin-top: auto; }
        .pose-ctrl-btn {
            flex: 1; padding: 13px; border-radius: 12px;
            border: 2px solid var(--secondary); background: white; color: var(--secondary);
            font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 0.9rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: var(--transition);
        }
        .pose-ctrl-btn:hover { background: var(--secondary); color: white; }
        .pose-ctrl-btn.danger { border-color: #ff4757; color: #ff4757; }
        .pose-ctrl-btn.danger:hover { background: #ff4757; color: white; }
        .pose-ctrl-btn.primary { background: var(--gradient); border-color: transparent; color: white; box-shadow: var(--shadow-sm); }

        /* summary inside panel */
        .pose-summary {
            display: none;
            flex-direction: column; gap: 14px;
            animation: fadeIn 0.4s ease-out;
        }
        .pose-summary.visible { display: flex; }

        .pose-summary-title { font-family: 'Rubik', sans-serif; font-weight: 900; font-size: 1.3rem; color: var(--primary); text-align: center; }
        .pose-summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .pose-summary-stat { background: var(--light); border-radius: 12px; padding: 14px; text-align: center; }
        .pose-summary-stat-val { font-family: 'Rubik', sans-serif; font-weight: 900; font-size: 1.8rem; color: var(--primary); }
        .pose-summary-stat-lbl { font-size: 0.75rem; color: rgba(26,26,46,0.5); font-weight: 600; margin-top: 4px; }
        .pose-summary-cues { list-style: none; display: flex; flex-direction: column; gap: 6px; }
        .pose-summary-cues li { font-size: 0.85rem; background: white; border: 1px solid #eee; padding: 8px 12px; border-radius: 8px; }


        /* â”€â”€ POSITION GUIDE BANNER â”€â”€ */
        .pose-position-banner {
            position: absolute; top: 14px; left: 50%; transform: translateX(-50%);
            z-index: 9; display: none;
            background: rgba(10,10,15,0.88); backdrop-filter: blur(8px);
            border: 1.5px solid rgba(255,210,63,0.6); border-radius: 40px;
            padding: 10px 20px; gap: 10px;
            align-items: center;
            font-family: 'Rubik', sans-serif; font-weight: 700; font-size: 0.85rem;
            color: #ffd23f; white-space: nowrap; pointer-events: none;
            animation: bannerPulse 1.5s ease-in-out infinite;
        }
        .pose-position-banner.visible { display: flex; }
        .pose-position-banner.good { border-color: rgba(6,214,160,0.6); color: #06d6a0; animation: none; }
        .ppb-icon { font-size: 1.2rem; }
        @keyframes bannerPulse {
            0%,100% { opacity: 1; } 50% { opacity: 0.6; }
        }

        /* â”€â”€ SILHOUETTE GUIDE (on canvas, drawn by JS) â”€â”€ */
        /* camera col needs overflow visible for guide labels */
        .pose-camera-col { overflow: hidden; }


        /* â”€â”€ CAMERA PLACEMENT GUIDE (in start overlay) â”€â”€ */
        .pose-placement-guide {
            background: rgba(255,255,255,0.08);
            border: 1.5px solid rgba(255,255,255,0.15);
            border-radius: 14px;
            padding: 14px 18px;
            display: flex; flex-direction: column; gap: 8px;
            max-width: 280px; width: 100%;
        }
        .ppg-row {
            display: flex; align-items: center; gap: 10px;
        }
        .ppg-icon { font-size: 1rem; flex-shrink: 0; }
        .ppg-text {
            color: rgba(255,255,255,0.85);
            font-size: 0.85rem; font-weight: 600;
        }


        /* â”€â”€ MUTE BUTTON positioning â”€â”€ */
        .pose-flip-btn {
            position: absolute; bottom: 14px; left: 14px; z-index: 9;
        }

        /* â”€â”€ COUNTDOWN OVERLAY â”€â”€ */
        .pose-countdown {
            position: absolute; inset: 0; z-index: 15;
            display: none;
            flex-direction: column;
            align-items: center; justify-content: center; gap: 16px;
            background: rgba(10,10,15,0.75); backdrop-filter: blur(4px);
        }
        .pose-countdown.active { display: flex; }

        .pose-countdown-num {
            font-family: 'Rubik', sans-serif;
            font-weight: 900;
            font-size: clamp(5rem, 20vw, 9rem);
            color: #fff;
            line-height: 1;
            animation: countPulse 1s ease-out;
        }
        @keyframes countPulse {
            0%   { transform: scale(1.4); opacity: 0.3; }
            40%  { transform: scale(1.0); opacity: 1;   }
            85%  { transform: scale(1.0); opacity: 1;   }
            100% { transform: scale(0.85); opacity: 0;  }
        }

        .pose-countdown-hint {
            font-family: 'Rubik', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: rgba(255,255,255,0.75);
            letter-spacing: 1px;
        }

        /* â”€â”€ FRAME-OK FLASH â”€â”€ */
        @keyframes frameOkFlash {
            0%   { box-shadow: inset 0 0 0 4px rgba(6,214,160,0);   }
            30%  { box-shadow: inset 0 0 0 4px rgba(6,214,160,0.9); }
            100% { box-shadow: inset 0 0 0 4px rgba(6,214,160,0);   }
        }
        .pose-camera-col.frame-ok { animation: frameOkFlash 0.7s ease-out; }

        /* â”€â”€ ANIMATIONS â”€â”€ */
        @keyframes fadeInDown { from{opacity:0;transform:translateY(-30px)} to{opacity:1;transform:translateY(0)} }
        @keyframes fadeInLeft { from{opacity:0;transform:translateX(-30px)} to{opacity:1;transform:translateX(0)} }
        @keyframes fadeInRight { from{opacity:0;transform:translateX(30px)} to{opacity:1;transform:translateX(0)} }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideDown { from{opacity:0;transform:translateY(-20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes spin { to{transform:rotate(360deg)} }

        /* â”€â”€ MOBILE â”€â”€ */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            header { padding: 30px 15px; margin-bottom: 20px; }
            .settings-panel { position: static; max-height: none; }
            .btn { min-width: 100%; padding: 16px 24px; }
            .workout-table { font-size: 0.9rem; }
            .workout-table thead th, .workout-table tbody td { padding: 12px 8px; }
            .timer-display { font-size: 3rem; }
            .action-buttons { flex-direction: column; }
            .pose-panel-col { border-radius: 0 0 var(--radius) var(--radius); }
            .pose-camera-col { border-radius: var(--radius) var(--radius) 0 0; min-height: 56vw; }
        }

        @supports (-webkit-touch-callout: none) {
            select { font-size: 16px; }
            input[type="checkbox"] { width: 24px; height: 24px; }
        }
    </style>
</head>
<body>
<div class="container">

    <header>
        <h1>ğŸ’ª YZ Exercise</h1>
        <p class="subtitle">××—×•×œ×œ ××™××•× ×™× ×—×›× ×•××™×©×™</p>
    </header>

    <!-- â”€â”€ NAV TABS â”€â”€ -->
    <div class="nav-tabs">
        <button class="nav-tab active" data-page="generator">ğŸ‹ï¸ ××—×•×œ×œ ××™××•× ×™×</button>
        <button class="nav-tab" data-page="analyzer">ğŸ“· × ×™×ª×•×— ×ª× ×•×¢×”</button>
        <button class="nav-tab" data-page="history-page">ğŸ“‹ ×”×™×¡×˜×•×¨×™×”</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE 1 â€” WORKOUT GENERATOR (original)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page active" id="page-generator">
        <div class="main-content">

            <aside class="settings-panel">
                <h2>âš™ï¸ ×”×’×“×¨×•×ª</h2>
                <div class="setting-group">
                    <h3>×›××•×ª ×ª×¨×’×™×œ×™×</h3>
                    <div class="select-wrapper">
                        <select id="exerciseCount">
                            <option value="3">3 ×ª×¨×’×™×œ×™×</option>
                            <option value="4">4 ×ª×¨×’×™×œ×™×</option>
                            <option value="5" selected>5 ×ª×¨×’×™×œ×™×</option>
                            <option value="6">6 ×ª×¨×’×™×œ×™×</option>
                            <option value="7">7 ×ª×¨×’×™×œ×™×</option>
                            <option value="8">8 ×ª×¨×’×™×œ×™×</option>
                        </select>
                    </div>
                </div>
                <div class="setting-group">
                    <h3>×¨××ª ×§×•×©×™</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="diff-easy" value="×§×œ" checked><label for="diff-easy">×§×œ</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="diff-medium" value="×‘×™× ×•× ×™" checked><label for="diff-medium">×‘×™× ×•× ×™</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="diff-hard" value="×§×©×”" checked><label for="diff-hard">×§×©×”</label></div>
                    </div>
                </div>
                <div class="setting-group">
                    <h3>×¦×™×•×“ ×–××™×Ÿ</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item"><input type="checkbox" id="eq-bodyweight" value="××©×§×œ ×’×•×£" checked><label for="eq-bodyweight">××©×§×œ ×’×•×£</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="eq-trx" value="TRX" checked><label for="eq-trx">TRX</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="eq-dumbbells" value="×“×××‘×œ×™×" checked><label for="eq-dumbbells">×“×××‘×œ×™×</label></div>
                        <div class="checkbox-item"><input type="checkbox" id="eq-band" value="×’×•××™×”" checked><label for="eq-band">×’×•××™×”</label></div>
                    </div>
                </div>
            </aside>

            <main class="workout-area">
                <div id="alertBox" class="alert"></div>

                <div class="action-buttons">
                    <button id="generateBtn" class="btn btn-primary">ğŸ‹ï¸ ×¦×•×¨ ××™××•×Ÿ ×—×“×©</button>
                    <button id="historyBtn" class="btn btn-secondary">ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ××™××•× ×™×</button>
                </div>

                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <p>×™×•×¦×¨ ××ª ×”××™××•×Ÿ ×”××•×©×œ× ×¢×‘×•×¨×š...</p>
                </div>

                <div id="workoutContainer" class="workout-container">
                    <div class="workout-header">
                        <h2>ğŸ¯ ×”×ª×•×›× ×™×ª ×©×œ×š</h2>
                        <div class="workout-stats"><span id="workoutDate" class="stat-badge"></span></div>
                    </div>
                    <table class="workout-table">
                        <thead>
                            <tr>
                                <th>#</th><th>×ª×¨×’×™×œ</th><th>×§×‘×•×¦×ª ×©×¨×™×¨</th>
                                <th>×¨××ª ×§×•×©×™</th><th>×¦×™×•×“</th><th>×”×“×¨×›×”</th><th>× ×™×ª×•×—</th>
                            </tr>
                        </thead>
                        <tbody id="workoutTableBody"></tbody>
                    </table>
                    <div class="export-buttons">
                        <button id="printBtn" class="btn-export">ğŸ–¨ï¸ ×”×“×¤×¡</button>
                        <button id="shareBtn" class="btn-export">ğŸ“¤ ×©×ª×£</button>
                        <button id="saveBtn" class="btn-export">ğŸ’¾ ×©××•×¨</button>
                    </div>
                </div>

                <div id="timerContainer" class="timer-container">
                    <h2>â±ï¸ ×˜×™×™××¨ ××™××•×Ÿ</h2>
                    <div class="timer-display" id="timerDisplay">00:00</div>
                    <div class="timer-controls">
                        <button id="startTimer" class="timer-btn btn-primary">×”×ª×—×œ</button>
                        <button id="pauseTimer" class="timer-btn btn-secondary">×¢×¦×•×¨</button>
                        <button id="resetTimer" class="timer-btn btn-secondary">××¤×¡</button>
                    </div>
                </div>

                <div id="historyContainer" class="history-container">
                    <h2>ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ××™××•× ×™×</h2>
                    <div id="historyList"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE 2 â€” POSE ANALYZER (new feature)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-analyzer">
        <div class="pose-page">
            <div class="pose-layout">

                <!-- Camera column -->
                <div class="pose-camera-col">
                    <video id="poseVideo" playsinline autoplay muted></video>
                    <canvas id="poseCanvas"></canvas>

                    <!-- Loading overlay -->
                    <div class="pose-loading-overlay" id="poseLoadingOverlay">
                        <div class="pose-spinner"></div>
                        <div class="pose-loading-text">×˜×•×¢×Ÿ MediaPipe Poseâ€¦</div>
                    </div>

                    <!-- Start overlay -->
                    <div class="pose-start-overlay" id="poseStartOverlay">
                        <div class="big-icon">ğŸ“·</div>
                        <div style="font-family:'Rubik',sans-serif;font-weight:900;font-size:1.3rem;color:#fff">×‘×—×¨ ×ª×¨×’×™×œ ×œ× ×™×ª×•×—</div>
                        <div class="pose-ex-btns">
                            <button class="pose-ex-btn active" data-ex="squat">ğŸ¦µ ×¡×§×•×•××˜</button>
                            <button class="pose-ex-btn" data-ex="pushup">ğŸ’ª Push-up</button>
                        </div>
                        <!-- Camera placement guide -->
                        <div class="pose-placement-guide" id="posePlacementGuide">
                            <div class="ppg-row">
                                <span class="ppg-icon">ğŸ“</span>
                                <span class="ppg-text" id="ppgAngle">××¦×œ××” ××”×¦×“ (×¤×¨×•×¤×™×œ 90Â°)</span>
                            </div>
                            <div class="ppg-row">
                                <span class="ppg-icon">ğŸ“</span>
                                <span class="ppg-text">××¨×—×§: 2â€“3 ××˜×¨ ××”××¦×œ××”</span>
                            </div>
                            <div class="ppg-row">
                                <span class="ppg-icon">ğŸ“</span>
                                <span class="ppg-text" id="ppgHeight">×’×•×‘×” ××¦×œ××”: ×’×•×‘×” ×”×™×¨×š</span>
                            </div>
                        </div>

                        <button class="pose-start-btn" id="poseStartBtn">â–¶ ×”×ª×—×œ × ×™×ª×•×—</button>
                        <div class="pose-permission-hint">×”×“×¤×“×¤×Ÿ ×™×‘×§×© ×’×™×©×” ×œ××¦×œ××”. ×›×œ ×”× ×ª×•× ×™× × ×©××¨×™× ×‘××›×©×™×¨ ×‘×œ×‘×“.</div>
                    </div>

                    <!-- Countdown overlay -->
                    <div class="pose-countdown" id="poseCountdown">
                        <div class="pose-countdown-num" id="poseCountdownNum">3</div>
                        <div class="pose-countdown-hint">×œ×š ×œ×¢××“×”!</div>
                    </div>

                    <!-- Position guide banner -->
                    <div class="pose-position-banner" id="posePositionBanner">
                        <div class="ppb-icon" id="ppbIcon">â†”</div>
                        <div class="ppb-text" id="ppbText">×”×ª×¨×—×§ ××”××¦×œ××” ×¢×“ ×©×›×œ ×”×’×•×£ ×‘×¤×¨×™×™×</div>
                    </div>

                    <!-- Feedback pill -->
                    <div class="pose-feedback-pill" id="poseFeedbackPill">×××ª×™×Ÿ ×œ×–×™×”×•×™â€¦</div>

                    <!-- Flip camera -->
                    <button class="pose-flip-btn" id="poseFlipBtn" title="×”×—×œ×£ ××¦×œ××”">ğŸ”„</button>

                    <!-- Mute toggle -->
                    <button class="pose-flip-btn" id="poseMuteBtn" title="×”×©×ª×§ ×¦×œ×™×œ×™×" style="bottom:66px">ğŸ””</button>

                    <!-- Zoom controls -->
                    <div class="pose-zoom-controls">
                        <button class="pose-zoom-btn" id="zoomIn" title="×¨××” ×™×•×ª×¨ (×–×•× ×××•×˜)">ğŸ”</button>
                        <div class="pose-zoom-label" id="zoomLabel">1.0Ã—</div>
                        <button class="pose-zoom-btn" id="zoomOut" title="×–×•× ××™×Ÿ">ğŸ”</button>
                    </div>
                </div>

                <!-- Stats panel -->
                <div class="pose-panel-col" id="posePanelCol">

                    <!-- Active session UI -->
                    <div id="poseActiveUI">
                        <div class="pose-panel-title" id="posePanelTitle">× ×™×ª×•×— ×ª× ×•×¢×”</div>

                        <div class="pose-rep-box">
                            <div class="pose-rep-num" id="poseRepNum">0</div>
                            <div class="pose-rep-lbl">×—×–×¨×•×ª</div>
                        </div>

                        <div class="pose-metrics" id="poseMetrics">
                            <!-- filled by JS -->
                        </div>

                        <div class="pose-controls">
                            <button class="pose-ctrl-btn danger" id="poseStopBtn">â¹ ×¡×™×•×</button>
                            <button class="pose-ctrl-btn" id="poseResetBtn">â†º ××¤×¡</button>
                        </div>
                    </div>

                    <!-- Summary (shown after stop) -->
                    <div class="pose-summary" id="poseSummary">
                        <div class="pose-summary-title">ğŸ† ×¡×™×›×•×</div>
                        <div class="pose-summary-grid" id="poseSummaryGrid"></div>
                        <ul class="pose-summary-cues" id="poseSummaryCues"></ul>
                        <div class="pose-controls">
                            <button class="pose-ctrl-btn primary" id="poseRestartBtn">ğŸ” ××™××•×Ÿ ×—×“×©</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         PAGE 3 â€” HISTORY (moved from inline)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="page-history-page">
        <div class="history-container active" style="display:block">
            <h2>ğŸ“‹ ×”×™×¡×˜×•×¨×™×™×ª ××™××•× ×™×</h2>
            <div id="historyListFull"></div>
        </div>
    </div>

</div><!-- /container -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('page-' + tab.dataset.page).classList.add('active');
        if (tab.dataset.page === 'history-page') renderHistoryFull();
    });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXERCISE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let exercisesData = [];

const ANALYZABLE = ['squat', 'pushup']; // exercises with pose support

// Map exercise names to pose types
function getPoseType(name) {
    const n = name.toLowerCase();
    if (n.includes('squat') || n.includes('×¡×§×•×•××˜')) return 'squat';
    if (n.includes('push') || n.includes('×¤×•×©')) return 'pushup';
    return null;
}

async function loadExercises() {
    try {
        const response = await fetch('exercises.json');
        if (response.ok) {
            const data = await response.json();
            if (data.Sheet1 && Array.isArray(data.Sheet1)) {
                exercisesData = data.Sheet1.map(ex => ({
                    name: ex['×©×'] || ex.name || '×œ×œ× ×©×',
                    muscle: ex['×§×‘×•×¦×ª ×©×¨×™×¨'] || ex.muscle || '×›×œ×œ×™',
                    difficulty: ex['×¨××ª ×§×•×©×™'] || ex.difficulty || '×‘×™× ×•× ×™',
                    equipment: ex['×¡×•×’ ×¦×™×•×“'] || ex.equipment || '××©×§×œ ×’×•×£',
                    link: ex['×§×™×©×•×¨'] || ex.link || '#'
                }));
            } else if (Array.isArray(data)) {
                exercisesData = data.map(ex => ({
                    name: ex['×©×'] || ex.name || '×œ×œ× ×©×',
                    muscle: ex['×§×‘×•×¦×ª ×©×¨×™×¨'] || ex.muscle || '×›×œ×œ×™',
                    difficulty: ex['×¨××ª ×§×•×©×™'] || ex.difficulty || '×‘×™× ×•× ×™',
                    equipment: ex['×¡×•×’ ×¦×™×•×“'] || ex.equipment || '××©×§×œ ×’×•×£',
                    link: ex['×§×™×©×•×¨'] || ex.link || '#'
                }));
            } else throw new Error('bad format');
        } else throw new Error('no file');
    } catch {
        exercisesData = [
            {name:"Push-ups",muscle:"×—×–×”",difficulty:"×§×œ",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=IODxDxX7oi4"},
            {name:"Squats",muscle:"×¨×’×œ×™×™×",difficulty:"×§×œ",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=aclHkVaku9U"},
            {name:"Plank",muscle:"×‘×˜×Ÿ",difficulty:"×‘×™× ×•× ×™",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=pSHjTRCQxIw"},
            {name:"Dumbbell Rows",muscle:"×’×‘",difficulty:"×‘×™× ×•× ×™",equipment:"×“×××‘×œ×™×",link:"https://www.youtube.com/watch?v=roCP6wCXPqo"},
            {name:"TRX Pull",muscle:"×’×‘",difficulty:"×§×©×”",equipment:"TRX",link:"https://www.youtube.com/watch?v=1234567890"},
            {name:"Lunges",muscle:"×¨×’×œ×™×™×",difficulty:"×‘×™× ×•× ×™",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=QOVaHwm-Q6U"},
            {name:"Shoulder Press",muscle:"×›×ª×¤×™×™×",difficulty:"×‘×™× ×•× ×™",equipment:"×“×××‘×œ×™×",link:"https://www.youtube.com/watch?v=qEwKCR5JCog"},
            {name:"Bicep Curls",muscle:"×™×“×™×™×",difficulty:"×§×œ",equipment:"×“×××‘×œ×™×",link:"https://www.youtube.com/watch?v=ykJmrZ5v0Oo"},
            {name:"Band Pull Apart",muscle:"×›×ª×¤×™×™×",difficulty:"×§×œ",equipment:"×’×•××™×”",link:"https://www.youtube.com/watch?v=VeCFg43kS9g"},
            {name:"Mountain Climbers",muscle:"×‘×˜×Ÿ",difficulty:"×§×©×”",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=nmwgirgXLYM"},
            {name:"Russian Twists",muscle:"×‘×˜×Ÿ",difficulty:"×‘×™× ×•× ×™",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=wkD8rjkodUI"},
            {name:"Deadlift",muscle:"×’×‘",difficulty:"×§×©×”",equipment:"×“×××‘×œ×™×",link:"https://www.youtube.com/watch?v=ytGaGIn3SjE"},
            {name:"Band Squats",muscle:"×¨×’×œ×™×™×",difficulty:"×§×©×”",equipment:"×’×•××™×”",link:"https://www.youtube.com/watch?v=abc789"},
            {name:"Pike Push-ups",muscle:"×›×ª×¤×™×™×",difficulty:"×§×©×”",equipment:"××©×§×œ ×’×•×£",link:"https://www.youtube.com/watch?v=spoSDo1P3O4"}
        ];
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORIGINAL WORKOUT GENERATOR LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentWorkout = null;
let workoutHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
let timerInterval = null;
let timerSeconds = 0;

document.getElementById('generateBtn').addEventListener('click', generateWorkout);
document.getElementById('historyBtn').addEventListener('click', toggleHistory);
document.getElementById('printBtn').addEventListener('click', printWorkout);
document.getElementById('shareBtn').addEventListener('click', shareWorkout);
document.getElementById('saveBtn').addEventListener('click', saveWorkout);
document.getElementById('startTimer').addEventListener('click', startTimer);
document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
document.getElementById('resetTimer').addEventListener('click', resetTimer);

function generateWorkout() {
    const selectedDifficulties = Array.from(document.querySelectorAll('input[id^="diff-"]:checked')).map(cb => cb.value);
    const selectedEquipment = Array.from(document.querySelectorAll('input[id^="eq-"]:checked')).map(cb => cb.value);
    const exerciseCount = parseInt(document.getElementById('exerciseCount').value);

    if (!selectedDifficulties.length || !selectedEquipment.length) {
        showAlert('×× × ×‘×—×¨ ×œ×¤×—×•×ª ×¨××ª ×§×•×©×™ ××—×ª ×•×¡×•×’ ×¦×™×•×“ ××—×“', 'error'); return;
    }

    document.getElementById('loading').classList.add('active');
    document.getElementById('workoutContainer').classList.remove('active');
    document.getElementById('historyContainer').classList.remove('active');

    setTimeout(() => {
        const filtered = exercisesData.filter(ex =>
            selectedDifficulties.includes(ex.difficulty) && selectedEquipment.includes(ex.equipment)
        );

        if (!filtered.length) {
            showAlert('×œ× × ××¦××• ×ª×¨×’×™×œ×™× ××ª××™××™×. × ×¡×” ×œ×©× ×•×ª ××ª ×”×”×’×“×¨×•×ª', 'warning');
            document.getElementById('loading').classList.remove('active'); return;
        }

        const workout = [], usedMuscles = new Set(), usedExercises = new Set();
        const shuffled = [...filtered].sort(() => Math.random() - 0.5);

        for (const ex of shuffled) {
            if (workout.length >= exerciseCount) break;
            if (!usedMuscles.has(ex.muscle) && !usedExercises.has(ex.name)) {
                workout.push(ex); usedMuscles.add(ex.muscle); usedExercises.add(ex.name);
            }
        }
        for (const ex of shuffled) {
            if (workout.length >= exerciseCount) break;
            if (!usedExercises.has(ex.name)) { workout.push(ex); usedExercises.add(ex.name); }
        }

        if (workout.length < exerciseCount) showAlert(`× ××¦××• ×¨×§ ${workout.length} ×ª×¨×’×™×œ×™× ××ª××™××™×`, 'warning');

        currentWorkout = { exercises: workout, date: new Date().toISOString(), settings: { count: exerciseCount, difficulties: selectedDifficulties, equipment: selectedEquipment } };
        displayWorkout(currentWorkout);
        document.getElementById('loading').classList.remove('active');
        showAlert('âœ… ××™××•×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”!', 'success');
    }, 1000);
}

function displayWorkout(workout) {
    const tbody = document.getElementById('workoutTableBody');
    tbody.innerHTML = '';
    workout.exercises.forEach((ex, i) => {
        const poseType = getPoseType(ex.name);
        const row = document.createElement('tr');
        row.style.animationDelay = `${i * 0.1}s`;
        row.innerHTML = `
            <td><strong>${i + 1}</strong></td>
            <td><strong>${ex.name}</strong></td>
            <td>${ex.muscle}</td>
            <td><span class="difficulty-badge difficulty-${ex.difficulty}">${ex.difficulty}</span></td>
            <td>${ex.equipment}</td>
            <td><a href="${ex.link}" target="_blank" class="exercise-link">ğŸ¥ ×”×“×¨×›×”</a></td>
            <td>${poseType
                ? `<button class="analyze-btn" data-pose="${poseType}">ğŸ“· × ×ª×—</button>`
                : '<span style="color:#bbb;font-size:.85rem">â€”</span>'
            }</td>
        `;
        tbody.appendChild(row);
    });

    // wire analyze buttons â†’ switch to analyzer tab with correct exercise
    tbody.querySelectorAll('.analyze-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const poseType = btn.dataset.pose;
            // switch tab
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelector('[data-page="analyzer"]').classList.add('active');
            document.getElementById('page-analyzer').classList.add('active');
            // pre-select exercise
            document.querySelectorAll('.pose-ex-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.ex === poseType);
            });
            poseState.exercise = poseType;
        });
    });

    document.getElementById('workoutDate').textContent = new Date(workout.date).toLocaleDateString('he-IL');
    document.getElementById('workoutContainer').classList.add('active');
    document.getElementById('timerContainer').classList.add('active');
}

function showAlert(msg, type) {
    const el = document.getElementById('alertBox');
    el.textContent = msg;
    el.className = `alert alert-${type} active`;
    setTimeout(() => el.classList.remove('active'), 5000);
}

function startTimer() {
    if (timerInterval) return;
    timerInterval = setInterval(() => { timerSeconds++; updateTimerDisplay(); }, 1000);
}
function pauseTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
function resetTimer() { pauseTimer(); timerSeconds = 0; updateTimerDisplay(); }
function updateTimerDisplay() {
    const m = Math.floor(timerSeconds / 60), s = timerSeconds % 60;
    document.getElementById('timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function saveWorkout() {
    if (!currentWorkout) { showAlert('××™×Ÿ ××™××•×Ÿ ×œ×©××•×¨', 'warning'); return; }
    workoutHistory.unshift(currentWorkout);
    if (workoutHistory.length > 10) workoutHistory = workoutHistory.slice(0, 10);
    localStorage.setItem('workoutHistory', JSON.stringify(workoutHistory));
    showAlert('ğŸ’¾ ×”××™××•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!', 'success');
}

function renderHistoryFull() {
    const el = document.getElementById('historyListFull');
    el.innerHTML = '';
    if (!workoutHistory.length) { el.innerHTML = '<p style="text-align:center;color:#666">××™×Ÿ ××™××•× ×™× ×©××•×¨×™×</p>'; return; }
    workoutHistory.forEach(workout => {
        const d = new Date(workout.date);
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div class="history-date">${d.toLocaleDateString('he-IL')} â€“ ${d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</div><div>${workout.exercises.length} ×ª×¨×’×™×œ×™×</div>`;
        item.addEventListener('click', () => {
            currentWorkout = workout;
            document.querySelector('[data-page="generator"]').click();
            displayWorkout(workout);
        });
        el.appendChild(item);
    });
}

function toggleHistory() {
    const h = document.getElementById('historyContainer'), w = document.getElementById('workoutContainer');
    if (h.classList.contains('active')) { h.classList.remove('active'); }
    else { loadHistoryInline(); h.classList.add('active'); w.classList.remove('active'); }
}
function loadHistoryInline() {
    const el = document.getElementById('historyList');
    el.innerHTML = '';
    if (!workoutHistory.length) { el.innerHTML = '<p style="text-align:center;color:#666">××™×Ÿ ××™××•× ×™× ×©××•×¨×™×</p>'; return; }
    workoutHistory.forEach(workout => {
        const d = new Date(workout.date);
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<div class="history-date">${d.toLocaleDateString('he-IL')} â€“ ${d.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</div><div>${workout.exercises.length} ×ª×¨×’×™×œ×™×</div>`;
        item.addEventListener('click', () => { currentWorkout = workout; displayWorkout(workout); document.getElementById('historyContainer').classList.remove('active'); });
        el.appendChild(item);
    });
}
function printWorkout() { if (!currentWorkout) { showAlert('××™×Ÿ ××™××•×Ÿ ×œ×”×“×¤×™×¡', 'warning'); return; } window.print(); }
async function shareWorkout() {
    if (!currentWorkout) { showAlert('××™×Ÿ ××™××•×Ÿ ×œ×©×ª×£', 'warning'); return; }
    const text = `×”××™××•×Ÿ ×©×œ×™ ×-YZ Exercise:\n\n${currentWorkout.exercises.map((e,i)=>`${i+1}. ${e.name} â€“ ${e.muscle}`).join('\n')}`;
    if (navigator.share) { try { await navigator.share({title:'YZ Exercise',text}); showAlert('âœ… ×©×•×ª×£!','success'); } catch{} }
    else { navigator.clipboard.writeText(text).then(()=>showAlert('ğŸ“‹ ×”×•×¢×ª×§','success')); }
}

const printStyle = document.createElement('style');
printStyle.textContent = `@media print{body *{visibility:hidden}#workoutContainer,#workoutContainer *{visibility:visible}#workoutContainer{position:absolute;left:0;top:0;width:100%}.export-buttons{display:none!important}}`;
document.head.appendChild(printStyle);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSE ANALYZER â€” STATE & EXERCISE DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const poseState = {
    exercise: 'squat',
    running: false,
    reps: 0,
    phase: 'up',
    facingUser: true,
    poseReady: false,
    session: { startTime: null, goodReps: 0, badReps: 0, cues: {} }
};

const POSE_EXERCISES = {
    squat: {
        name: '×¡×§×•×•××˜',
        metrics: [
            { id:'knee', label:'×–×•×•×™×ª ×‘×¨×š' },
            { id:'hip',  label:'×–×•×•×™×ª ×™×¨×š' },
            { id:'back', label:'×˜×™×™×ª ×’×‘'   }
        ],
        analyze(lms) {
            const L = i => lms[i];
            const ang = (A,B,C) => {
                const BA={x:A.x-B.x,y:A.y-B.y}, BC={x:C.x-B.x,y:C.y-B.y};
                const d = BA.x*BC.x+BA.y*BC.y, m = Math.hypot(BA.x,BA.y)*Math.hypot(BC.x,BC.y);
                return m ? Math.round(Math.acos(Math.min(1,Math.max(-1,d/m)))*180/Math.PI) : 0;
            };
            const kneeA = Math.round((ang(L(24),L(26),L(28))+ang(L(23),L(25),L(27)))/2);
            const hipA  = Math.round((ang(L(12),L(24),L(26))+ang(L(11),L(23),L(25)))/2);
            const msx=(L(12).x+L(11).x)/2, msy=(L(12).y+L(11).y)/2;
            const mhx=(L(24).x+L(23).x)/2, mhy=(L(24).y+L(23).y)/2;
            const backA = Math.round(Math.abs(Math.atan2(msx-mhx,msy-mhy)*180/Math.PI));

            const cues = []; let quality = 'good';
            if (kneeA < 70)        cues.push('ğŸŸ¢ ×¢×•××§ ××¦×•×™×Ÿ!');
            else if (kneeA < 100)  { quality='warn'; cues.push('ğŸŸ¡ ×¨×“ ×§×¦×ª ×™×•×ª×¨'); }
            else                   { quality='bad';  cues.push('ğŸ”´ ×¢×•××§ ×œ× ××¡×¤×™×§'); }
            if (backA > 40)        { quality='bad';  cues.push('ğŸ”´ ×’×‘ ×§×“××™ â€“ ×”×›× ×¡ ×—×–×”'); }
            else if (backA > 25)   { if(quality==='good')quality='warn'; cues.push('ğŸŸ¡ ×©×™× ×œ×‘ ×œ×’×‘ ×–×§×•×£'); }

            const isDown = kneeA < 120;
            let repCounted = false;
            if (isDown && poseState.phase==='up') poseState.phase='down';
            else if (!isDown && poseState.phase==='down') {
                poseState.phase='up'; repCounted=true;
                if (quality==='good') poseState.session.goodReps++; else poseState.session.badReps++;
                cues.forEach(c => { poseState.session.cues[c]=(poseState.session.cues[c]||0)+1; });
            }
            return { repCounted, quality, cues, metrics: {
                knee: { val:kneeA+'Â°', quality: kneeA<100?'good':kneeA<130?'warn':'bad', bar: Math.max(0,Math.min(100,100-(kneeA-70)/1.1)) },
                hip:  { val:hipA+'Â°',  quality: hipA<70?'good':'warn',                   bar: Math.max(0,Math.min(100,100-(hipA-50)/1.3))  },
                back: { val:backA+'Â°', quality: backA<25?'good':backA<40?'warn':'bad',   bar: Math.max(0,Math.min(100,100-backA*2.2))       }
            }};
        }
    },

    pushup: {
        name: 'Push-up',
        metrics: [
            { id:'elbow', label:'××¨×¤×§'    },
            { id:'body',  label:'×§×• ×’×•×£'  },
            { id:'depth', label:'×¢×•××§ %'  }
        ],
        analyze(lms) {
            const L = i => lms[i];
            const ang = (A,B,C) => {
                const BA={x:A.x-B.x,y:A.y-B.y}, BC={x:C.x-B.x,y:C.y-B.y};
                const d=BA.x*BC.x+BA.y*BC.y, m=Math.hypot(BA.x,BA.y)*Math.hypot(BC.x,BC.y);
                return m?Math.round(Math.acos(Math.min(1,Math.max(-1,d/m)))*180/Math.PI):0;
            };
            const elbA = Math.round((ang(L(12),L(14),L(16))+ang(L(11),L(13),L(15)))/2);
            const bodyA = Math.round((ang(L(12),L(24),L(28))+ang(L(11),L(23),L(27)))/2);
            const dev = Math.abs(180-bodyA);
            const depth = Math.max(0,Math.min(100,Math.round((180-elbA))));

            const cues=[]; let quality='good';
            if (elbA<80)        cues.push('ğŸŸ¢ ×¢×•××§ ××¦×•×™×Ÿ!');
            else if (elbA<130)  { quality='warn'; cues.push('ğŸŸ¡ ×¨×“ ×§×¦×ª ×™×•×ª×¨'); }
            else                { quality='bad';  cues.push('ğŸ”´ ×¢×•××§ ×œ× ××¡×¤×™×§'); }
            if (dev>25)         { quality='bad';  cues.push('ğŸ”´ ×™×¨×›×™×™× ×’×‘×•×”×•×ª ××“×™'); }
            else if (dev>12)    { if(quality==='good')quality='warn'; cues.push('ğŸŸ¡ ×©××•×¨ ×¢×œ ×§×• ×™×©×¨'); }
            else                cues.push('ğŸŸ¢ ×§×• ×’×•×£ ××•×©×œ×!');

            const isDown = elbA<130;
            let repCounted=false;
            if (isDown && poseState.phase==='up') poseState.phase='down';
            else if (!isDown && poseState.phase==='down') {
                poseState.phase='up'; repCounted=true;
                if(quality==='good') poseState.session.goodReps++; else poseState.session.badReps++;
                cues.forEach(c=>{ poseState.session.cues[c]=(poseState.session.cues[c]||0)+1; });
            }
            return { repCounted, quality, cues, metrics: {
                elbow: { val:elbA+'Â°',  quality: elbA<90?'good':elbA<130?'warn':'bad', bar: Math.max(0,Math.min(100,(180-elbA))) },
                body:  { val:dev+'Â°',   quality: dev<12?'good':dev<25?'warn':'bad',    bar: Math.max(0,Math.min(100,100-dev*3.5)) },
                depth: { val:depth+'%', quality: depth>55?'good':depth>30?'warn':'bad', bar: depth }
            }};
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDIAPIPE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mpPose = null, mpCamera = null, currentStream = null;

async function initPose() {
    mpPose = new Pose({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
    mpPose.setOptions({ modelComplexity:1, smoothLandmarks:true, enableSegmentation:false, minDetectionConfidence:0.55, minTrackingConfidence:0.55 });
    mpPose.onResults(onPoseResults);
    await mpPose.initialize();
    poseState.poseReady = true;
    document.getElementById('poseLoadingOverlay').classList.add('hidden');
}

async function startPoseCamera() {
    if (currentStream) currentStream.getTracks().forEach(t => t.stop());
    const facingMode = poseState.facingUser ? 'user' : 'environment';
    try {
        currentStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode, width:{ideal:1280}, height:{ideal:720} }, audio: false
        });
        const vid = document.getElementById('poseVideo');
        vid.srcObject = currentStream;
        await vid.play();
        vid.style.transform = poseState.facingUser ? 'scaleX(-1)' : 'scaleX(1)';
        document.getElementById('poseCanvas').style.transform = poseState.facingUser ? 'scaleX(-1)' : 'scaleX(1)';
        // apply zoom after transform is set
        setTimeout(() => applyZoom(), 50);

        if (mpCamera) mpCamera.stop();
        mpCamera = new Camera(vid, {
            onFrame: async () => { if (poseState.running) await mpPose.send({ image: vid }); },
            width: 640, height: 960
        });
        mpCamera.start();
    } catch { alert('×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”. ×× × ××©×¨ ×”×¨×©××•×ª.'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SILHOUETTE GUIDE DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Each exercise defines where the silhouette should appear (normalized 0-1)
// and which camera angle is recommended
const SILHOUETTES = {
    squat: {
        cameraAngle: '×¦×“ (×¤×¨×•×¤×™×œ 90Â°)',
        cameraIcon: 'â†”',
        // Stick figure key points (x, y normalized 0-1) for standing position
        // Drawn as a simple skeleton guide the user should match
        standing: [
            // head
            { type: 'circle', x: 0.5, y: 0.08, r: 0.04 },
            // torso
            { type: 'line', x1: 0.5, y1: 0.12, x2: 0.5, y2: 0.45 },
            // left arm
            { type: 'line', x1: 0.5, y1: 0.18, x2: 0.38, y2: 0.32 },
            { type: 'line', x1: 0.38, y1: 0.32, x2: 0.32, y2: 0.42 },
            // right arm
            { type: 'line', x1: 0.5, y1: 0.18, x2: 0.62, y2: 0.32 },
            { type: 'line', x1: 0.62, y1: 0.32, x2: 0.68, y2: 0.42 },
            // left leg
            { type: 'line', x1: 0.5, y1: 0.45, x2: 0.44, y2: 0.7 },
            { type: 'line', x1: 0.44, y1: 0.7,  x2: 0.44, y2: 0.94 },
            // right leg
            { type: 'line', x1: 0.5, y1: 0.45, x2: 0.56, y2: 0.7 },
            { type: 'line', x1: 0.56, y1: 0.7,  x2: 0.56, y2: 0.94 },
        ],
        // bounding box that body MUST fill
        targetBox: { x: 0.22, y: 0.03, w: 0.56, h: 0.94 }
    },
    pushup: {
        cameraAngle: '×¦×“ (×¤×¨×•×¤×™×œ 90Â°)',
        cameraIcon: 'â†”',
        standing: [
            // head
            { type: 'circle', x: 0.12, y: 0.38, r: 0.05 },
            // body (horizontal)
            { type: 'line', x1: 0.17, y1: 0.40, x2: 0.72, y2: 0.55 },
            // arms
            { type: 'line', x1: 0.24, y1: 0.42, x2: 0.18, y2: 0.62 },
            { type: 'line', x1: 0.18, y1: 0.62, x2: 0.15, y2: 0.72 },
            // legs
            { type: 'line', x1: 0.72, y1: 0.55, x2: 0.80, y2: 0.72 },
            { type: 'line', x1: 0.80, y1: 0.72, x2: 0.88, y2: 0.74 },
        ],
        targetBox: { x: 0.06, y: 0.30, w: 0.88, h: 0.50 }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BODY IN FRAME CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Key landmarks needed per exercise (must be visible)
const REQUIRED_LMS = {
    squat:  [0, 11, 12, 23, 24, 25, 26, 27, 28],  // nose, shoulders, hips, knees, ankles
    pushup: [0, 11, 12, 13, 14, 15, 16, 23, 24, 27, 28]
};

function checkBodyInFrame(lms) {
    const required = REQUIRED_LMS[poseState.exercise] || REQUIRED_LMS.squat;
    const missing = required.filter(i => (lms[i].visibility || 0) < 0.5);

    // Check if body fills reasonable portion of frame (not too close, not too far)
    const visLms = [0,11,12,23,24,25,26,27,28]
        .filter(i => (lms[i].visibility || 0) > 0.4)
        .map(i => lms[i]);

    if (visLms.length < 3) return { ok: false, msg: 'âš ï¸ ×œ× × ××¦× ×’×•×£ â€“ ×¢××•×“ ××•×œ ×”××¦×œ××”', dir: 'none' };

    const xs = visLms.map(p => p.x), ys = visLms.map(p => p.y);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const bodyW = maxX - minX, bodyH = maxY - minY;

    // Too close (body fills too much)
    if (bodyW > 0.85 || bodyH > 0.92) return { ok: false, msg: 'â¬…ï¸ ×”×ª×¨×—×§ ××”××¦×œ××”', dir: 'far' };

    // Too far (body too small)
    if (bodyH < 0.45 && required.includes(27)) return { ok: false, msg: 'â¡ï¸ ×”×ª×§×¨×‘ ×§×¦×ª', dir: 'close' };

    // Body cut off on sides
    if (minX < 0.04) return { ok: false, msg: 'â† ×”×¡×˜ ×©×××œ×”', dir: 'right' };
    if (maxX > 0.96) return { ok: false, msg: 'â†’ ×”×¡×˜ ×™××™× ×”', dir: 'left' };

    // Missing critical landmarks
    if (missing.length > 2) {
        const isBottom = missing.some(i => [25,26,27,28].includes(i));
        const isTop    = missing.some(i => [0,11,12].includes(i));
        if (isBottom) return { ok: false, msg: 'â¬‡ï¸ ×”× ××š ××ª ×”××¦×œ××” ××• ×”×ª×¨×—×§', dir: 'far' };
        if (isTop)    return { ok: false, msg: 'â¬†ï¸ ×”×’×‘×” ××ª ×”××¦×œ××” ××• ×”×ª×¨×—×§', dir: 'far' };
        return { ok: false, msg: 'â†”ï¸ ×”×¡×ª×•×‘×‘ ×œ×¦×“ ×”××¦×œ××”', dir: 'rotate' };
    }

    return { ok: true, msg: 'âœ… ××™×§×•× ××•×©×œ×!', dir: 'ok' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSE RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastPoseCue = '';
let frameCheckCooldown = 0;

function onPoseResults(results) {
    const canvas = document.getElementById('poseCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width  = results.image.width;
    canvas.height = results.image.height;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const sil = SILHOUETTES[poseState.exercise];

    if (!results.poseLandmarks) {
        // Draw silhouette guide when no body detected
        drawSilhouette(ctx, canvas, sil, false);
        setPoseFeedback('âš ï¸ ×œ× ×–×•×”×” ×’×•×£ â€“ ×¢××•×“ ×‘×¤×¨×™×™×', 'warn');
        showPositionBanner(true, 'â¬…ï¸ ×”×ª×¨×—×§ ××”××¦×œ××” ×¢×“ ×©×›×œ ×”×’×•×£ × ×¨××”', false);
        return;
    }

    const lms = results.poseLandmarks;

    // Check body positioning every frame
    const frameCheck = checkBodyInFrame(lms);

    if (!frameCheck.ok) {
        // Body detected but not fully in frame â€” show silhouette + direction
        drawSilhouette(ctx, canvas, sil, false);
        drawPoseSkeleton(ctx, canvas, lms, 'warn');  // show skeleton even if partial
        showPositionBanner(true, frameCheck.msg, false);
        setPoseFeedback(frameCheck.msg, 'warn');
        return;
    }

    // Body fully in frame â€” hide banner, run analysis
    showPositionBanner(false, 'âœ… ××™×§×•× ××•×©×œ×!', true);

    const ex  = POSE_EXERCISES[poseState.exercise];
    const res = ex.analyze(lms);

    drawPoseSkeleton(ctx, canvas, lms, res.quality);
    updatePoseMetrics(res.metrics);

    const cue = res.cues[0] || 'âœ… ×”××©×š ×›×š!';
    if (cue !== lastPoseCue) { lastPoseCue = cue; setPoseFeedback(cue, res.quality); }

    if (res.repCounted) {
        poseState.reps++;
        playRepSound();
        const el = document.getElementById('poseRepNum');
        el.textContent = poseState.reps;
        el.classList.add('flash');
        setTimeout(() => el.classList.remove('flash'), 350);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSITION BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bannerTimeout = null;
let lastFrameOk = false; // track edge: not-ok â†’ ok

function showPositionBanner(show, msg, isGood) {
    const el  = document.getElementById('posePositionBanner');
    const txt = document.getElementById('ppbText');
    const ico = document.getElementById('ppbIcon');
    const cam = document.getElementById('cameraWrap') || document.querySelector('.pose-camera-col');

    // Detect transition: bad â†’ good â†’ play sound + flash
    if (isGood && !lastFrameOk) {
        playFrameOkSound();
        // green border flash on camera column
        const col = document.querySelector('.pose-camera-col');
        if (col) {
            col.classList.remove('frame-ok');
            col.offsetHeight; // reflow
            col.classList.add('frame-ok');
            setTimeout(() => col.classList.remove('frame-ok'), 700);
        }
    }
    lastFrameOk = isGood;

    if (show) {
        txt.textContent = msg;
        ico.textContent = isGood ? 'âœ…' : 'â†”';
        el.className = 'pose-position-banner visible' + (isGood ? ' good' : '');
        if (isGood) {
            if (bannerTimeout) clearTimeout(bannerTimeout);
            bannerTimeout = setTimeout(() => el.classList.remove('visible'), 2000);
        }
    } else {
        el.classList.remove('visible');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SILHOUETTE DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSilhouette(ctx, canvas, sil, active) {
    if (!sil) return;
    const W = canvas.width, H = canvas.height;
    const alpha = active ? 0.9 : 0.35;
    const color = active ? 'rgba(255,210,63,' + alpha + ')' : 'rgba(255,255,255,0.25)';

    // Draw target bounding box (dashed)
    const tb = sil.targetBox;
    ctx.save();
    ctx.setLineDash([12, 8]);
    ctx.strokeStyle = 'rgba(255,210,63,0.4)';
    ctx.lineWidth = 2;
    ctx.strokeRect(tb.x * W, tb.y * H, tb.w * W, tb.h * H);
    ctx.setLineDash([]);

    // Corner decorations
    const cSize = 18, cx = tb.x * W, cy = tb.y * H, cw = tb.w * W, ch = tb.h * H;
    ctx.strokeStyle = 'rgba(255,210,63,0.8)';
    ctx.lineWidth = 3;
    // top-left
    ctx.beginPath(); ctx.moveTo(cx, cy + cSize); ctx.lineTo(cx, cy); ctx.lineTo(cx + cSize, cy); ctx.stroke();
    // top-right
    ctx.beginPath(); ctx.moveTo(cx+cw-cSize, cy); ctx.lineTo(cx+cw, cy); ctx.lineTo(cx+cw, cy+cSize); ctx.stroke();
    // bottom-left
    ctx.beginPath(); ctx.moveTo(cx, cy+ch-cSize); ctx.lineTo(cx, cy+ch); ctx.lineTo(cx+cSize, cy+ch); ctx.stroke();
    // bottom-right
    ctx.beginPath(); ctx.moveTo(cx+cw-cSize, cy+ch); ctx.lineTo(cx+cw, cy+ch); ctx.lineTo(cx+cw, cy+ch-cSize); ctx.stroke();

    // Label inside box
    ctx.font = `bold ${Math.round(W * 0.028)}px Rubik, Heebo, sans-serif`;
    ctx.fillStyle = 'rgba(255,210,63,0.7)';
    ctx.textAlign = 'center';
    ctx.fillText('×¢××•×“ ×›××Ÿ', (tb.x + tb.w/2) * W, (tb.y + tb.h + 0.04) * H);

    // Stick figure
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = 3;
    ctx.shadowColor = 'rgba(255,210,63,0.5)';
    ctx.shadowBlur = 8;
    for (const s of sil.standing) {
        if (s.type === 'circle') {
            ctx.beginPath();
            ctx.arc(s.x * W, s.y * H, s.r * Math.min(W,H), 0, Math.PI * 2);
            ctx.stroke();
        } else if (s.type === 'line') {
            ctx.beginPath();
            ctx.moveTo(s.x1 * W, s.y1 * H);
            ctx.lineTo(s.x2 * W, s.y2 * H);
            ctx.stroke();
        }
    }
    ctx.shadowBlur = 0;
    ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SKELETON DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONNECTIONS = [[11,12],[11,13],[13,15],[12,14],[14,16],[11,23],[12,24],[23,24],[23,25],[24,26],[25,27],[26,28]];

function qualityColor(q) { return q==='good'?'#06d6a0':q==='warn'?'#ffd23f':'#ff4757'; }

function drawPoseSkeleton(ctx, canvas, lms, quality) {
    const W=canvas.width, H=canvas.height, color=qualityColor(quality);
    ctx.lineWidth=4; ctx.strokeStyle=color; ctx.shadowColor=color; ctx.shadowBlur=12;
    for (const [a,b] of CONNECTIONS) {
        const pA=lms[a], pB=lms[b];
        if ((pA.visibility||0)<0.4||(pB.visibility||0)<0.4) continue;
        ctx.beginPath(); ctx.moveTo(pA.x*W,pA.y*H); ctx.lineTo(pB.x*W,pB.y*H); ctx.stroke();
    }
    ctx.shadowBlur=18;
    [11,12,13,14,15,16,23,24,25,26,27,28].forEach(i => {
        const p=lms[i]; if((p.visibility||0)<0.4) return;
        ctx.beginPath(); ctx.arc(p.x*W,p.y*H,7,0,Math.PI*2);
        ctx.fillStyle=color; ctx.fill();
    });
    ctx.shadowBlur=0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setPoseFeedback(text, quality) {
    const el = document.getElementById('poseFeedbackPill');
    el.textContent = text;
    el.className = `pose-feedback-pill ${quality==='good'?'good':quality==='warn'?'warn':quality==='bad'?'bad':''}`;
}

function buildPoseMetrics() {
    const ex = POSE_EXERCISES[poseState.exercise];
    document.getElementById('poseMetrics').innerHTML = ex.metrics.map(m => `
        <div class="pose-metric-card" id="pmc-${m.id}">
            <div class="pose-metric-top">
                <span class="pose-metric-name">${m.label}</span>
                <span class="pose-metric-val" id="pmv-${m.id}">â€”</span>
            </div>
            <div class="pose-bar-wrap"><div class="pose-bar" id="pmb-${m.id}" style="width:0%"></div></div>
        </div>
    `).join('');
}

function updatePoseMetrics(metrics) {
    Object.entries(metrics).forEach(([id, m]) => {
        const card = document.getElementById('pmc-'+id);
        const val  = document.getElementById('pmv-'+id);
        const bar  = document.getElementById('pmb-'+id);
        if (!card) return;
        card.className = `pose-metric-card ${m.quality}`;
        val.textContent = m.val;
        bar.style.width = m.bar + '%';
        bar.style.background = qualityColor(m.quality);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WEB AUDIO â€” ×¦×œ×™×œ×™×
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let soundEnabled = true;

function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
}

// ×¦×œ×™×œ "×‘×™× ×’" â€” ×›×©×”×’×•×£ ×‘××§×•× ×”× ×›×•×Ÿ
function playFrameOkSound() {
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);

        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime);          // A5
        osc.frequency.exponentialRampToValueAtTime(1320, ctx.currentTime + 0.12); // E6

        gain.gain.setValueAtTime(0, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.4, ctx.currentTime + 0.04);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.55);

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.55);
    } catch(e) {}
}

// ×¦×œ×™×œ "×˜×™×§" â€” ×¡×¤×™×¨×” ×œ××—×•×¨
function playTickSound(isFinal) {
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);

        osc.type = 'sine';
        const freq = isFinal ? 1047 : 660; // C6 vs E5
        osc.frequency.setValueAtTime(freq, ctx.currentTime);

        gain.gain.setValueAtTime(0.35, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (isFinal ? 0.5 : 0.18));

        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + (isFinal ? 0.5 : 0.2));
    } catch(e) {}
}

// ×¦×œ×™×œ "×¤×™× ×’" â€” ×—×–×¨×” × ×¡×¤×¨×”
function playRepSound() {
    if (!soundEnabled) return;
    try {
        const ctx = getAudioCtx();
        [0, 0.1].forEach((offset, i) => {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(i === 0 ? 523 : 784, ctx.currentTime + offset);
            gain.gain.setValueAtTime(0.3, ctx.currentTime + offset);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + offset + 0.25);
            osc.start(ctx.currentTime + offset);
            osc.stop(ctx.currentTime + offset + 0.28);
        });
    } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COUNTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runCountdown(seconds, onDone) {
    const overlay = document.getElementById('poseCountdown');
    const numEl   = document.getElementById('poseCountdownNum');
    overlay.classList.add('active');

    let remaining = seconds;

    function tick() {
        numEl.textContent = remaining;
        // re-trigger animation
        numEl.style.animation = 'none';
        numEl.offsetHeight; // reflow
        numEl.style.animation = 'countPulse 1s ease-out forwards';

        playTickSound(remaining === 1);

        if (remaining <= 0) {
            overlay.classList.remove('active');
            onDone();
            return;
        }
        remaining--;
        setTimeout(tick, 1000);
    }
    tick();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startPoseSession() {
    poseState.running=true; poseState.reps=0; poseState.phase='up'; lastPoseCue='';
    poseState.frameWasOk = false; // track transition to OK
    poseState.session={ startTime:Date.now(), goodReps:0, badReps:0, cues:{} };
    document.getElementById('poseRepNum').textContent='0';
    document.getElementById('posePanelTitle').textContent = 'ğŸ“· ' + POSE_EXERCISES[poseState.exercise].name;
    buildPoseMetrics();
    document.getElementById('poseActiveUI').style.display='block';
    document.getElementById('poseSummary').classList.remove('visible');
    setPoseFeedback('ğŸ¯ ×”×ª×—×œ ××ª ×”×ª×¨×’×™×œ!','');
}

function stopPoseSession() {
    poseState.running=false;
    if (currentStream) currentStream.getTracks().forEach(t=>t.stop());
    showPoseSummary();
}

function resetPoseReps() {
    poseState.reps=0; poseState.phase='up'; lastPoseCue='';
    poseState.session.goodReps=0; poseState.session.badReps=0; poseState.session.cues={}; poseState.session.startTime=Date.now();
    document.getElementById('poseRepNum').textContent='0';
}

function showPoseSummary() {
    const dur = poseState.session.startTime ? Math.round((Date.now()-poseState.session.startTime)/1000) : 0;
    const m=Math.floor(dur/60), s=dur%60;
    const goodPct = poseState.reps>0 ? Math.round(poseState.session.goodReps/poseState.reps*100) : 0;

    document.getElementById('poseSummaryGrid').innerHTML = `
        <div class="pose-summary-stat"><div class="pose-summary-stat-val">${poseState.reps}</div><div class="pose-summary-stat-lbl">×—×–×¨×•×ª</div></div>
        <div class="pose-summary-stat"><div class="pose-summary-stat-val">${goodPct}%</div><div class="pose-summary-stat-lbl">×—×–×¨×•×ª ×˜×•×‘×•×ª</div></div>
        <div class="pose-summary-stat"><div class="pose-summary-stat-val">${poseState.session.goodReps}</div><div class="pose-summary-stat-lbl">âœ… ××¦×•×™×Ÿ</div></div>
        <div class="pose-summary-stat"><div class="pose-summary-stat-val">${m}:${String(s).padStart(2,'0')}</div><div class="pose-summary-stat-lbl">×–××Ÿ</div></div>
    `;

    const topCues = Object.entries(poseState.session.cues).sort((a,b)=>b[1]-a[1]).slice(0,3);
    document.getElementById('poseSummaryCues').innerHTML = topCues.length
        ? topCues.map(([cue,n])=>`<li>${cue} <span style="margin-right:auto;color:#aaa;font-size:.8rem">x${n}</span></li>`).join('')
        : '<li>ğŸ’ª ×‘×™×¦×•×¢ ××¦×•×™×Ÿ!</li>';

    document.getElementById('poseActiveUI').style.display='none';
    document.getElementById('poseSummary').classList.add('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSE EVENT LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Exercise placement hints
const PLACEMENT_HINTS = {
    squat:  { angle: '××¦×œ××” ××”×¦×“ (×¤×¨×•×¤×™×œ 90Â°)', height: '×’×•×‘×” ××¦×œ××”: ×’×•×‘×” ×”×™×¨×š', dist: '××¨×—×§: 2â€“3 ××˜×¨' },
    pushup: { angle: '××¦×œ××” ××”×¦×“ (×¤×¨×•×¤×™×œ 90Â°)', height: '×’×•×‘×” ××¦×œ××”: ×’×•×‘×” ×”×›×ª×£ / ×¨×¦×¤×”', dist: '××¨×—×§: 1.5â€“2 ××˜×¨' }
};

function updatePlacementGuide(ex) {
    const h = PLACEMENT_HINTS[ex];
    if (!h) return;
    const angle  = document.getElementById('ppgAngle');
    const height = document.getElementById('ppgHeight');
    if (angle)  angle.textContent  = h.angle;
    if (height) height.textContent = h.height;
}

document.querySelectorAll('.pose-ex-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.pose-ex-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        poseState.exercise = btn.dataset.ex;
        updatePlacementGuide(btn.dataset.ex);
    });
});

document.getElementById('poseStartBtn').addEventListener('click', async () => {
    const overlay = document.getElementById('poseStartOverlay');
    overlay.classList.add('hidden');

    if (!poseState.poseReady) {
        document.getElementById('poseLoadingOverlay').classList.add('visible');
        await initPose();
    }

    await startPoseCamera();

    // ×¡×¤×™×¨×” ×œ××—×•×¨ ×œ×¤× ×™ ×©××ª×—×™×œ â€” ×–××Ÿ ×œ×œ×›×ª ×œ×¢××“×”
    runCountdown(3, () => {
        startPoseSession();
    });
});

document.getElementById('poseFlipBtn').addEventListener('click', async () => {
    poseState.facingUser = !poseState.facingUser;
    if (poseState.running) await startPoseCamera();
});

document.getElementById('poseMuteBtn').addEventListener('click', () => {
    soundEnabled = !soundEnabled;
    document.getElementById('poseMuteBtn').textContent = soundEnabled ? 'ğŸ””' : 'ğŸ”•';
});

// â”€â”€ ZOOM â”€â”€
// "+" ×›×¤×ª×•×¨ = ×¨××” ×™×•×ª×¨ = scale ×§×˜×Ÿ ×™×•×ª×¨ = ×–×•× ×××•×˜
// "âˆ’" ×›×¤×ª×•×¨ = ×–×•× ××™×Ÿ = scale ×’×“×•×œ ×™×•×ª×¨
let zoomLevel = 1.0;
const ZOOM_STEP = 0.1, ZOOM_MIN = 0.4, ZOOM_MAX = 1.8;

function applyZoom() {
    const vid    = document.getElementById('poseVideo');
    const canvas = document.getElementById('poseCanvas');
    const mirror = poseState.facingUser ? -1 : 1;
    vid.style.transform    = `scaleX(${mirror * zoomLevel}) scaleY(${zoomLevel})`;
    canvas.style.transform = `scaleX(${mirror * zoomLevel}) scaleY(${zoomLevel})`;
    document.getElementById('zoomLabel').textContent = zoomLevel.toFixed(1) + 'Ã—';
}

document.getElementById('zoomIn').addEventListener('click', () => {
    // "+" = ×¨××” ×™×•×ª×¨ = scale ×§×˜×Ÿ (×–×•× ×××•×˜)
    zoomLevel = Math.max(ZOOM_MIN, parseFloat((zoomLevel - ZOOM_STEP).toFixed(1)));
    applyZoom();
});
document.getElementById('zoomOut').addEventListener('click', () => {
    // "âˆ’" = ×–×•× ××™×Ÿ = scale ×’×“×•×œ
    zoomLevel = Math.min(ZOOM_MAX, parseFloat((zoomLevel + ZOOM_STEP).toFixed(1)));
    applyZoom();
});

// zoom is reset inside startPoseCamera via applyZoom()

document.getElementById('poseStopBtn').addEventListener('click', stopPoseSession);
document.getElementById('poseResetBtn').addEventListener('click', resetPoseReps);
document.getElementById('poseRestartBtn').addEventListener('click', () => {
    document.getElementById('poseSummary').classList.remove('visible');
    document.getElementById('poseActiveUI').style.display='block';
    document.getElementById('poseStartOverlay').classList.remove('hidden');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', async () => {
    await loadExercises();
    // Preload MediaPipe in background after page ready
    setTimeout(() => {
        if (!poseState.poseReady) {
            initPose().catch(e => console.warn('MediaPipe preload failed:', e));
        }
    }, 2000);
});
</script>
</body>
</html>
