<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>YZ Exercise â€“ × ×™×ª×•×— ×ª× ×•×¢×”</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&family=Rubik:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #13131a;
  --surface2: #1c1c28;
  --border: rgba(255,255,255,0.07);
  --orange: #ff6b35;
  --orange-dim: rgba(255,107,53,0.15);
  --orange-glow: rgba(255,107,53,0.4);
  --green: #06d6a0;
  --green-dim: rgba(6,214,160,0.15);
  --red: #ff4757;
  --red-dim: rgba(255,71,87,0.15);
  --yellow: #ffd23f;
  --text: #f0f0f8;
  --muted: rgba(240,240,248,0.45);
  --radius: 18px;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'Heebo', sans-serif;
  overflow: hidden;
}

/* â”€â”€ LAYOUT â”€â”€ */
.app {
  display: flex;
  flex-direction: column;
  height: 100dvh;
  position: relative;
}

/* â”€â”€ TOPBAR â”€â”€ */
.topbar {
  position: absolute;
  top: 0; left: 0; right: 0;
  z-index: 30;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: linear-gradient(to bottom, rgba(10,10,15,0.95) 0%, transparent 100%);
}

.logo {
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 1.3rem;
  color: var(--orange);
  letter-spacing: -0.5px;
}
.logo span { color: var(--text); }

.camera-flip-btn {
  width: 42px; height: 42px;
  border-radius: 50%;
  border: 1.5px solid var(--border);
  background: rgba(19,19,26,0.8);
  color: var(--text);
  font-size: 1.2rem;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  backdrop-filter: blur(8px);
  transition: all 0.2s;
}
.camera-flip-btn:active { transform: scale(0.9); background: var(--orange-dim); }

/* â”€â”€ CAMERA CANVAS â”€â”€ */
.camera-wrap {
  position: relative;
  flex: 1;
  overflow: hidden;
  background: #000;
}

#videoEl {
  position: absolute;
  width: 100%; height: 100%;
  object-fit: cover;
  transform: scaleX(-1);
}

#poseCanvas {
  position: absolute;
  inset: 0;
  width: 100%; height: 100%;
  object-fit: cover;
}

/* â”€â”€ START OVERLAY â”€â”€ */
.start-overlay {
  position: absolute;
  inset: 0;
  z-index: 20;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(10,10,15,0.85);
  backdrop-filter: blur(6px);
  gap: 24px;
  transition: opacity 0.5s;
}
.start-overlay.hidden { opacity: 0; pointer-events: none; }

.start-icon {
  font-size: 4rem;
  animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
  0%,100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.exercise-selector {
  display: flex;
  gap: 12px;
}

.ex-btn {
  padding: 14px 28px;
  border-radius: 14px;
  border: 2px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  font-family: 'Rubik', sans-serif;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s;
}
.ex-btn.active, .ex-btn:hover {
  border-color: var(--orange);
  background: var(--orange-dim);
  color: var(--orange);
  box-shadow: 0 0 20px var(--orange-glow);
}

.start-btn {
  padding: 18px 52px;
  border-radius: 16px;
  border: none;
  background: var(--orange);
  color: #fff;
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 1.2rem;
  cursor: pointer;
  letter-spacing: 0.5px;
  box-shadow: 0 4px 24px var(--orange-glow);
  transition: all 0.2s;
}
.start-btn:active { transform: scale(0.96); }

.permission-hint {
  color: var(--muted);
  font-size: 0.85rem;
  text-align: center;
  max-width: 260px;
  line-height: 1.5;
}

/* â”€â”€ FEEDBACK PILL (live) â”€â”€ */
.feedback-pill {
  position: absolute;
  top: 80px; left: 50%; transform: translateX(-50%);
  z-index: 25;
  background: rgba(19,19,26,0.88);
  backdrop-filter: blur(10px);
  border: 1.5px solid var(--border);
  border-radius: 40px;
  padding: 10px 22px;
  font-family: 'Rubik', sans-serif;
  font-weight: 700;
  font-size: 0.95rem;
  white-space: nowrap;
  transition: all 0.3s;
  pointer-events: none;
}
.feedback-pill.good  { border-color: var(--green); color: var(--green); background: rgba(6,214,160,0.12); }
.feedback-pill.warn  { border-color: var(--yellow); color: var(--yellow); background: rgba(255,210,63,0.12); }
.feedback-pill.bad   { border-color: var(--red); color: var(--red); background: rgba(255,71,87,0.12); }
.feedback-pill.idle  { color: var(--muted); }

/* â”€â”€ BOTTOM HUD â”€â”€ */
.hud {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  z-index: 30;
  padding: 0 16px 28px;
  background: linear-gradient(to top, rgba(10,10,15,0.97) 0%, transparent 100%);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* rep counter row */
.rep-row {
  display: flex;
  justify-content: center;
  align-items: flex-end;
  gap: 8px;
}

.rep-count {
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 5.5rem;
  line-height: 1;
  color: var(--orange);
  text-shadow: 0 0 40px var(--orange-glow);
  transition: all 0.15s;
}
.rep-count.flash {
  transform: scale(1.15);
  text-shadow: 0 0 60px var(--orange-glow);
}

.rep-label {
  font-size: 1rem;
  color: var(--muted);
  margin-bottom: 12px;
  font-weight: 700;
}

/* metric cards */
.metrics-row {
  display: flex;
  gap: 10px;
}

.metric-card {
  flex: 1;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 14px;
  padding: 12px 10px;
  text-align: center;
  transition: border-color 0.3s, background 0.3s;
}
.metric-card.good { border-color: var(--green); background: var(--green-dim); }
.metric-card.warn { border-color: var(--yellow); background: rgba(255,210,63,0.1); }
.metric-card.bad  { border-color: var(--red); background: var(--red-dim); }

.metric-val {
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 1.5rem;
  color: var(--text);
}
.metric-lbl {
  font-size: 0.72rem;
  color: var(--muted);
  margin-top: 2px;
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* bottom controls */
.controls-row {
  display: flex;
  gap: 10px;
}

.ctrl-btn {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  border: 1.5px solid var(--border);
  background: var(--surface2);
  color: var(--text);
  font-family: 'Rubik', sans-serif;
  font-weight: 700;
  font-size: 0.9rem;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: all 0.2s;
}
.ctrl-btn:active { transform: scale(0.96); }
.ctrl-btn.primary {
  background: var(--orange);
  border-color: var(--orange);
  box-shadow: 0 2px 16px var(--orange-glow);
}
.ctrl-btn.danger { border-color: var(--red); color: var(--red); background: var(--red-dim); }

/* â”€â”€ ANGLE ARC overlay â”€â”€ */
.angle-display {
  position: absolute;
  top: 50%;
  right: 16px;
  transform: translateY(-50%);
  z-index: 25;
  display: flex;
  flex-direction: column;
  gap: 10px;
  pointer-events: none;
}

.angle-chip {
  background: rgba(10,10,15,0.82);
  backdrop-filter: blur(8px);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 10px 14px;
  text-align: center;
  min-width: 72px;
  transition: border-color 0.3s;
}
.angle-chip.good { border-color: var(--green); }
.angle-chip.warn { border-color: var(--yellow); }
.angle-chip.bad  { border-color: var(--red); }
.angle-chip-val {
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 1.2rem;
  color: var(--text);
}
.angle-chip-lbl {
  font-size: 0.65rem;
  color: var(--muted);
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  margin-top: 2px;
}

/* â”€â”€ SESSION SUMMARY MODAL â”€â”€ */
.summary-modal {
  position: absolute;
  inset: 0;
  z-index: 50;
  display: flex;
  align-items: flex-end;
  padding: 20px;
  background: rgba(10,10,15,0.7);
  backdrop-filter: blur(8px);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s;
}
.summary-modal.visible {
  opacity: 1;
  pointer-events: all;
}

.summary-card {
  width: 100%;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  padding: 28px 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  transform: translateY(60px);
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
}
.summary-modal.visible .summary-card { transform: translateY(0); }

.summary-title {
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 1.5rem;
  color: var(--orange);
  text-align: center;
}

.summary-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.summary-stat {
  background: var(--surface2);
  border-radius: 14px;
  padding: 16px;
  text-align: center;
}
.summary-stat-val {
  font-family: 'Rubik', sans-serif;
  font-weight: 900;
  font-size: 2rem;
  color: var(--orange);
}
.summary-stat-lbl {
  font-size: 0.8rem;
  color: var(--muted);
  font-weight: 600;
  margin-top: 4px;
}

.summary-feedback-list {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.summary-feedback-list li {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.9rem;
  color: var(--muted);
  background: var(--surface2);
  padding: 10px 14px;
  border-radius: 10px;
}

.summary-actions {
  display: flex;
  gap: 10px;
}

/* â”€â”€ LOADING SCREEN â”€â”€ */
.loading-screen {
  position: absolute;
  inset: 0;
  z-index: 40;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 20px;
  transition: opacity 0.6s;
}
.loading-screen.hidden { opacity: 0; pointer-events: none; }

.loader-ring {
  width: 64px; height: 64px;
  border: 4px solid var(--surface2);
  border-top-color: var(--orange);
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

.loader-text {
  color: var(--muted);
  font-size: 0.95rem;
  font-weight: 600;
  text-align: center;
  max-width: 240px;
  line-height: 1.6;
}

/* â”€â”€ REP FLASH â”€â”€ */
@keyframes repFlash {
  0%   { box-shadow: 0 0 0 0 var(--orange-glow); }
  50%  { box-shadow: 0 0 0 30px transparent; }
  100% { box-shadow: 0 0 0 0 transparent; }
}
.camera-wrap.flash-frame { animation: repFlash 0.4s ease-out; }

/* progress bar inside metric card */
.metric-bar-wrap {
  height: 4px;
  background: rgba(255,255,255,0.08);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.metric-bar {
  height: 100%;
  border-radius: 2px;
  transition: width 0.3s, background 0.3s;
}
</style>
</head>
<body>
<div class="app">

  <!-- Loading -->
  <div class="loading-screen" id="loadingScreen">
    <div style="font-family:'Rubik',sans-serif;font-weight:900;font-size:1.6rem;color:var(--orange)">ğŸ’ª YZ Exercise</div>
    <div class="loader-ring"></div>
    <div class="loader-text">×˜×•×¢×Ÿ ×× ×•×¢ × ×™×ª×•×— ×ª× ×•×¢×”<br>MediaPipe Poseâ€¦</div>
  </div>

  <!-- Top bar -->
  <div class="topbar">
    <div class="logo">YZ <span>Exercise</span></div>
    <button class="camera-flip-btn" id="flipBtn" title="×”×—×œ×£ ××¦×œ××”">ğŸ”„</button>
  </div>

  <!-- Camera -->
  <div class="camera-wrap" id="cameraWrap">
    <video id="videoEl" playsinline autoplay muted></video>
    <canvas id="poseCanvas"></canvas>

    <!-- Feedback pill -->
    <div class="feedback-pill idle" id="feedbackPill">×××ª×™×Ÿ ×œ×–×™×”×•×™â€¦</div>

    <!-- Angle chips -->
    <div class="angle-display" id="angleDisplay" style="display:none">
      <div class="angle-chip" id="chipKnee">
        <div class="angle-chip-val" id="chipKneeVal">â€”Â°</div>
        <div class="angle-chip-lbl" id="chipKneeLbl">×‘×¨×š</div>
      </div>
      <div class="angle-chip" id="chipHip">
        <div class="angle-chip-val" id="chipHipVal">â€”Â°</div>
        <div class="angle-chip-lbl" id="chipHipLbl">×™×¨×š</div>
      </div>
    </div>

    <!-- Start overlay -->
    <div class="start-overlay" id="startOverlay">
      <div class="start-icon">ğŸ¯</div>
      <div style="font-family:'Rubik',sans-serif;font-weight:900;font-size:1.4rem;text-align:center">×‘×—×¨ ×ª×¨×’×™×œ</div>
      <div class="exercise-selector">
        <button class="ex-btn active" data-ex="squat">ğŸ¦µ ×¡×§×•×•××˜</button>
        <button class="ex-btn" data-ex="pushup">ğŸ’ª Push-up</button>
      </div>
      <button class="start-btn" id="startBtn">â–¶ ×”×ª×—×œ × ×™×ª×•×—</button>
      <div class="permission-hint">×”×¢×¨×”: ×”×“×¤×“×¤×Ÿ ×™×‘×§×© ×’×™×©×” ×œ××¦×œ××”. ×›×œ ×”× ×ª×•× ×™× × ×©××¨×™× ×‘××›×©×™×¨ ×©×œ×š ×‘×œ×‘×“.</div>
    </div>
  </div>

  <!-- HUD -->
  <div class="hud" id="hud" style="display:none">

    <!-- Rep counter -->
    <div class="rep-row">
      <div class="rep-count" id="repCount">0</div>
      <div class="rep-label">×—×–×¨×•×ª</div>
    </div>

    <!-- Metric cards -->
    <div class="metrics-row" id="metricsRow">
      <!-- filled dynamically -->
    </div>

    <!-- Controls -->
    <div class="controls-row">
      <button class="ctrl-btn danger" id="stopBtn">â¹ ×¡×™×•×</button>
      <button class="ctrl-btn primary" id="resetRepBtn">â†º ××¤×¡</button>
    </div>
  </div>

  <!-- Summary Modal -->
  <div class="summary-modal" id="summaryModal">
    <div class="summary-card">
      <div class="summary-title">ğŸ† ×¡×™×›×•× ××™××•×Ÿ</div>
      <div class="summary-stats" id="summaryStats"></div>
      <ul class="summary-feedback-list" id="summaryFeedback"></ul>
      <div class="summary-actions">
        <button class="ctrl-btn" id="summaryClose" style="flex:1">âœ• ×¡×’×•×¨</button>
        <button class="ctrl-btn primary" id="summaryRestart" style="flex:2">ğŸ” ××™××•×Ÿ ×—×“×©</button>
      </div>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function angle3(A, B, C) {
  // angle at B
  const BA = { x: A.x - B.x, y: A.y - B.y };
  const BC = { x: C.x - B.x, y: C.y - B.y };
  const dot = BA.x * BC.x + BA.y * BC.y;
  const magBA = Math.hypot(BA.x, BA.y);
  const magBC = Math.hypot(BC.x, BC.y);
  if (magBA === 0 || magBC === 0) return 0;
  return Math.round(Math.acos(Math.min(1, Math.max(-1, dot / (magBA * magBC)))) * (180 / Math.PI));
}

function lm(landmarks, idx) {
  const p = landmarks[idx];
  return { x: p.x, y: p.y, z: p.z, vis: p.visibility };
}

function lerp(a, b, t) { return a + (b - a) * t; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  exercise: 'squat',
  running: false,
  reps: 0,
  phase: 'up',           // for squat/pushup phase tracking
  facingUser: true,
  session: {
    startTime: null,
    repTimestamps: [],
    goodReps: 0,
    badReps: 0,
    cues: {}              // cue -> count
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXERCISE DEFINITIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EXERCISES = {
  squat: {
    name: '×¡×§×•×•××˜',
    metrics: [
      { id: 'knee', label: '×‘×¨×š', lbl2: '×‘×¨×š' },
      { id: 'hip',  label: '×™×¨×š', lbl2: '×™×¨×š' },
      { id: 'back', label: '×’×‘',  lbl2: '×’×‘'  }
    ],
    analyze(lms) {
      const rHip   = lm(lms, 24), rKnee = lm(lms, 26), rAnkle = lm(lms, 28);
      const lHip   = lm(lms, 23), lKnee = lm(lms, 25), lAnkle = lm(lms, 27);
      const rShou  = lm(lms, 12), lShou  = lm(lms, 11);

      const kneeAngleR = angle3(rHip, rKnee, rAnkle);
      const kneeAngleL = angle3(lHip, lKnee, lAnkle);
      const kneeAngle  = Math.round((kneeAngleR + kneeAngleL) / 2);

      const hipAngleR = angle3(rShou, rHip, rKnee);
      const hipAngleL = angle3(lShou, lHip, lKnee);
      const hipAngle  = Math.round((hipAngleR + hipAngleL) / 2);

      // Back vertical: shoulder - hip - knee angle from vertical
      const midShouX = (rShou.x + lShou.x) / 2, midShouY = (rShou.y + lShou.y) / 2;
      const midHipX  = (rHip.x  + lHip.x)  / 2, midHipY  = (rHip.y + lHip.y)  / 2;
      const backAngle = Math.round(Math.abs(
        Math.atan2(midShouX - midHipX, midShouY - midHipY) * 180 / Math.PI
      ));

      const cues = [];
      let quality = 'good';

      if (kneeAngle < 70) { cues.push('ğŸŸ¢ ×¢×•××§ ××¦×•×™×Ÿ!'); }
      else if (kneeAngle < 100) { quality = 'warn'; cues.push('ğŸŸ¡ ×¨×“ ×§×¦×ª ×™×•×ª×¨'); }
      else { quality = 'bad'; cues.push('ğŸ”´ ×¢×•××§ ×œ× ××¡×¤×™×§'); }

      if (backAngle > 40) { quality = 'bad'; cues.push('ğŸ”´ ×’×‘ ×§×“××™ â€“ ×”×›× ×¡ ×—×–×”'); }
      else if (backAngle > 25) { if (quality === 'good') quality = 'warn'; cues.push('ğŸŸ¡ ×©×™× ×œ×‘ ×œ×’×‘ ×–×§×•×£'); }

      // phase detection
      const isDown = kneeAngle < 120;
      let repCounted = false;
      if (isDown && state.phase === 'up') {
        state.phase = 'down';
      } else if (!isDown && state.phase === 'down') {
        state.phase = 'up';
        repCounted = true;
        if (quality === 'good') state.session.goodReps++;
        else state.session.badReps++;
        cues.forEach(c => { state.session.cues[c] = (state.session.cues[c] || 0) + 1; });
      }

      return {
        repCounted,
        quality,
        cues,
        metrics: {
          knee: { val: kneeAngle,  unit: 'Â°', label: '×–×•×•×™×ª ×‘×¨×š',  quality: kneeAngle < 100 ? 'good' : kneeAngle < 130 ? 'warn' : 'bad', bar: Math.max(0, Math.min(100, 100 - (kneeAngle - 70) / 1.1)) },
          hip:  { val: hipAngle,   unit: 'Â°', label: '×–×•×•×™×ª ×™×¨×š',  quality: hipAngle < 70 ? 'good' : 'warn', bar: Math.max(0, Math.min(100, 100 - (hipAngle - 50) / 1.3)) },
          back: { val: backAngle,  unit: 'Â°', label: '×˜×™×™×ª ×’×‘',    quality: backAngle < 25 ? 'good' : backAngle < 40 ? 'warn' : 'bad', bar: Math.max(0, Math.min(100, 100 - backAngle * 2.2)) }
        }
      };
    }
  },

  pushup: {
    name: 'Push-up',
    metrics: [
      { id: 'elbow', label: '××¨×¤×§', lbl2: '××¨×¤×§' },
      { id: 'body',  label: '×’×•×£',  lbl2: '×§×• ×’×•×£' },
      { id: 'depth', label: '×¢×•××§', lbl2: '×¢×•××§'  }
    ],
    analyze(lms) {
      const rShou  = lm(lms, 12), rElb = lm(lms, 14), rWrist = lm(lms, 16);
      const lShou  = lm(lms, 11), lElb = lm(lms, 13), lWrist = lm(lms, 15);
      const rHip   = lm(lms, 24), lHip = lm(lms, 23);
      const rAnk   = lm(lms, 28), lAnk = lm(lms, 27);

      const elbR = angle3(rShou, rElb, rWrist);
      const elbL = angle3(lShou, lElb, lWrist);
      const elbAngle = Math.round((elbR + elbL) / 2);

      // body line (shoulder - hip - ankle)
      const bodyR = angle3(rShou, rHip, rAnk);
      const bodyL = angle3(lShou, lHip, lAnk);
      const bodyAngle = Math.round((bodyR + bodyL) / 2);
      const deviation = Math.abs(180 - bodyAngle);

      const cues = [];
      let quality = 'good';

      // elbow check
      if (elbAngle < 80)       { cues.push('ğŸŸ¢ ×¢×•××§ ××¦×•×™×Ÿ!'); }
      else if (elbAngle < 130) { quality = 'warn'; cues.push('ğŸŸ¡ ×¨×“ ×§×¦×ª ×™×•×ª×¨'); }
      else                     { quality = 'bad';  cues.push('ğŸ”´ ×¢×•××§ ×œ× ××¡×¤×™×§'); }

      // body line
      if (deviation > 25) { quality = 'bad'; cues.push('ğŸ”´ ×™×¨×›×™×™× ×’×‘×•×”×•×ª/× ××•×›×•×ª'); }
      else if (deviation > 12) { if (quality === 'good') quality = 'warn'; cues.push('ğŸŸ¡ ×©××•×¨ ×¢×œ ×§×• ×™×©×¨'); }
      else { cues.push('ğŸŸ¢ ×§×• ×’×•×£ ××•×©×œ×!'); }

      const isDown = elbAngle < 130;
      let repCounted = false;
      if (isDown && state.phase === 'up') {
        state.phase = 'down';
      } else if (!isDown && state.phase === 'down') {
        state.phase = 'up';
        repCounted = true;
        if (quality === 'good') state.session.goodReps++;
        else state.session.badReps++;
        cues.forEach(c => { state.session.cues[c] = (state.session.cues[c] || 0) + 1; });
      }

      const depth = Math.max(0, Math.min(100, Math.round((180 - elbAngle) / 1.0)));

      return {
        repCounted,
        quality,
        cues,
        metrics: {
          elbow: { val: elbAngle,   unit: 'Â°', label: '××¨×¤×§', quality: elbAngle < 90 ? 'good' : elbAngle < 130 ? 'warn' : 'bad', bar: Math.max(0,Math.min(100, (180-elbAngle)/1.0)) },
          body:  { val: deviation,  unit: 'Â°', label: '×§×• ×’×•×£',  quality: deviation < 12 ? 'good' : deviation < 25 ? 'warn' : 'bad', bar: Math.max(0,Math.min(100,100-deviation*3.5)) },
          depth: { val: depth,      unit: '%', label: '×¢×•××§',    quality: depth > 55 ? 'good' : depth > 30 ? 'warn' : 'bad', bar: depth }
        }
      };
    }
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $  = id => document.getElementById(id);
const videoEl      = $('videoEl');
const poseCanvas   = $('poseCanvas');
const ctx          = poseCanvas.getContext('2d');
const feedbackPill = $('feedbackPill');
const repCountEl   = $('repCount');
const metricsRow   = $('metricsRow');
const angleDisplay = $('angleDisplay');
const chipKnee     = $('chipKnee');
const chipKneeVal  = $('chipKneeVal');
const chipKneeLbl  = $('chipKneeLbl');
const chipHip      = $('chipHip');
const chipHipVal   = $('chipHipVal');
const chipHipLbl   = $('chipHipLbl');
const hud          = $('hud');
const cameraWrap   = $('cameraWrap');
const startOverlay = $('startOverlay');
const summaryModal = $('summaryModal');
const loadingScreen= $('loadingScreen');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MEDIAPIPE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pose = null;
let camera = null;
let currentStream = null;

async function initPose() {
  pose = new Pose({
    locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
  });
  pose.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: false,
    smoothSegmentation: false,
    minDetectionConfidence: 0.55,
    minTrackingConfidence: 0.55
  });
  pose.onResults(onResults);
  await pose.initialize();
  loadingScreen.classList.add('hidden');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startCamera() {
  if (currentStream) {
    currentStream.getTracks().forEach(t => t.stop());
  }
  const facingMode = state.facingUser ? 'user' : 'environment';
  try {
    currentStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 640 }, height: { ideal: 1280 } },
      audio: false
    });
    videoEl.srcObject = currentStream;
    await videoEl.play();

    // mirror only for front camera
    videoEl.style.transform = state.facingUser ? 'scaleX(-1)' : 'scaleX(1)';
    poseCanvas.style.transform = state.facingUser ? 'scaleX(-1)' : 'scaleX(1)';

    if (camera) camera.stop();
    camera = new Camera(videoEl, {
      onFrame: async () => {
        if (state.running) await pose.send({ image: videoEl });
      },
      width: 640, height: 1280
    });
    camera.start();
  } catch (err) {
    alert('×œ× × ×™×ª×Ÿ ×œ×’×©×ª ×œ××¦×œ××”. ×× × ××©×¨ ×”×¨×©××•×ª.');
    console.error(err);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POSE RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lastCues = [];

function onResults(results) {
  // Resize canvas to video
  poseCanvas.width  = results.image.width;
  poseCanvas.height = results.image.height;

  ctx.clearRect(0, 0, poseCanvas.width, poseCanvas.height);

  if (!results.poseLandmarks) {
    setFeedback('âš ï¸ ×œ× ×–×•×”×” ×’×•×£ â€“ ×¢××•×“ ×‘×¤×¨×™×™×', 'warn');
    return;
  }

  const lms = results.poseLandmarks;
  const ex  = EXERCISES[state.exercise];
  const analysis = ex.analyze(lms);

  // Draw skeleton
  drawSkeleton(lms, analysis.quality);

  // Update UI
  updateMetrics(analysis.metrics);
  updateAngleChips(analysis.metrics);

  const cue = analysis.cues[0] || 'âœ… ×”××©×š ×›×š!';
  const sameAsBefore = lastCues[0] === cue;
  if (!sameAsBefore) {
    lastCues = analysis.cues;
    setFeedback(cue, analysis.quality);
  }

  if (analysis.repCounted) {
    state.reps++;
    state.session.repTimestamps.push(Date.now());
    repCountEl.textContent = state.reps;
    repCountEl.classList.add('flash');
    cameraWrap.classList.add('flash-frame');
    setTimeout(() => {
      repCountEl.classList.remove('flash');
      cameraWrap.classList.remove('flash-frame');
    }, 400);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SKELETON DRAWING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const POSE_CONNECTIONS = [
  [11,12],[11,13],[13,15],[12,14],[14,16],
  [11,23],[12,24],[23,24],[23,25],[24,26],[25,27],[26,28]
];

function qualityColor(q) {
  if (q === 'good') return '#06d6a0';
  if (q === 'warn') return '#ffd23f';
  return '#ff4757';
}

function drawSkeleton(lms, overallQuality) {
  const W = poseCanvas.width, H = poseCanvas.height;
  const color = qualityColor(overallQuality);

  ctx.lineWidth = 4;
  ctx.strokeStyle = color;
  ctx.shadowColor = color;
  ctx.shadowBlur = 10;

  // connections
  for (const [a, b] of POSE_CONNECTIONS) {
    const pA = lms[a], pB = lms[b];
    if ((pA.visibility || 0) < 0.4 || (pB.visibility || 0) < 0.4) continue;
    ctx.beginPath();
    ctx.moveTo(pA.x * W, pA.y * H);
    ctx.lineTo(pB.x * W, pB.y * H);
    ctx.stroke();
  }

  // joints
  const joints = [11,12,13,14,15,16,23,24,25,26,27,28];
  for (const i of joints) {
    const p = lms[i];
    if ((p.visibility || 0) < 0.4) continue;
    ctx.beginPath();
    ctx.arc(p.x * W, p.y * H, 8, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.shadowBlur = 16;
    ctx.fill();
  }
  ctx.shadowBlur = 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFeedback(text, type) {
  feedbackPill.textContent = text;
  feedbackPill.className = `feedback-pill ${type === 'good' ? 'good' : type === 'warn' ? 'warn' : type === 'bad' ? 'bad' : 'idle'}`;
}

function updateMetrics(metrics) {
  const keys = Object.keys(metrics);
  const cards = metricsRow.querySelectorAll('.metric-card');
  keys.forEach((k, i) => {
    const m = metrics[k];
    const card = cards[i];
    if (!card) return;
    card.className = `metric-card ${m.quality}`;
    card.querySelector('.metric-val').textContent = m.val + m.unit;
    const bar = card.querySelector('.metric-bar');
    if (bar) {
      bar.style.width = m.bar + '%';
      bar.style.background = qualityColor(m.quality);
    }
  });
}

function updateAngleChips(metrics) {
  const keys = Object.keys(metrics);
  if (keys[0]) {
    const m0 = metrics[keys[0]];
    chipKneeVal.textContent = m0.val + m0.unit;
    chipKneeLbl.textContent = m0.label;
    chipKnee.className = `angle-chip ${m0.quality}`;
  }
  if (keys[1]) {
    const m1 = metrics[keys[1]];
    chipHipVal.textContent = m1.val + m1.unit;
    chipHipLbl.textContent = m1.label;
    chipHip.className = `angle-chip ${m1.quality}`;
  }
}

function buildMetricsRow() {
  const ex = EXERCISES[state.exercise];
  metricsRow.innerHTML = ex.metrics.map(m => `
    <div class="metric-card" id="mc-${m.id}">
      <div class="metric-val" id="mv-${m.id}">â€”</div>
      <div class="metric-lbl">${m.label}</div>
      <div class="metric-bar-wrap"><div class="metric-bar" id="mb-${m.id}" style="width:0%"></div></div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SESSION CONTROL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSession() {
  state.running = true;
  state.reps = 0;
  state.phase = 'up';
  state.session = { startTime: Date.now(), repTimestamps: [], goodReps: 0, badReps: 0, cues: {} };
  lastCues = [];

  repCountEl.textContent = '0';
  buildMetricsRow();
  startOverlay.classList.add('hidden');
  angleDisplay.style.display = 'flex';
  hud.style.display = 'flex';
  setFeedback('ğŸ¯ ' + EXERCISES[state.exercise].name + ' â€“ ×‘×•× × ×ª×—×™×œ!', 'idle');
}

function stopSession() {
  state.running = false;
  showSummary();
}

function resetReps() {
  state.reps = 0;
  state.phase = 'up';
  repCountEl.textContent = '0';
  state.session.goodReps = 0;
  state.session.badReps = 0;
  state.session.repTimestamps = [];
  state.session.cues = {};
  state.session.startTime = Date.now();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSummary() {
  const duration = state.session.startTime
    ? Math.round((Date.now() - state.session.startTime) / 1000)
    : 0;
  const mins = Math.floor(duration / 60), secs = duration % 60;
  const durationStr = `${mins}:${String(secs).padStart(2,'0')}`;

  const goodPct = state.reps > 0 ? Math.round(state.session.goodReps / state.reps * 100) : 0;

  $('summaryStats').innerHTML = `
    <div class="summary-stat"><div class="summary-stat-val">${state.reps}</div><div class="summary-stat-lbl">×—×–×¨×•×ª ×¡×”"×›</div></div>
    <div class="summary-stat"><div class="summary-stat-val">${goodPct}%</div><div class="summary-stat-lbl">×—×–×¨×•×ª ×˜×•×‘×•×ª</div></div>
    <div class="summary-stat"><div class="summary-stat-val">${state.session.goodReps}</div><div class="summary-stat-lbl">××¦×•×™×Ÿ âœ…</div></div>
    <div class="summary-stat"><div class="summary-stat-val">${durationStr}</div><div class="summary-stat-lbl">×–××Ÿ</div></div>
  `;

  // top cues
  const topCues = Object.entries(state.session.cues)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);

  $('summaryFeedback').innerHTML = topCues.length
    ? topCues.map(([cue, n]) => `<li><span>${cue}</span><span style="margin-right:auto;color:var(--muted);font-size:.8rem">x${n}</span></li>`).join('')
    : '<li>ğŸ’ª ×‘×™×¦×•×¢ ××¦×•×™×Ÿ â€“ ×”××©×š ×›×š!</li>';

  summaryModal.classList.add('visible');
}

function hideSummary() {
  summaryModal.classList.remove('visible');
  hud.style.display = 'none';
  angleDisplay.style.display = 'none';
  startOverlay.classList.remove('hidden');
  setFeedback('×××ª×™×Ÿ ×œ×–×™×”×•×™â€¦', 'idle');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EVENT LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.ex-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.ex-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.exercise = btn.dataset.ex;
  });
});

$('startBtn').addEventListener('click', async () => {
  await startCamera();
  startSession();
});

$('flipBtn').addEventListener('click', async () => {
  state.facingUser = !state.facingUser;
  await startCamera();
});

$('stopBtn').addEventListener('click', stopSession);
$('resetRepBtn').addEventListener('click', resetReps);
$('summaryClose').addEventListener('click', hideSummary);
$('summaryRestart').addEventListener('click', () => {
  hideSummary();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initPose().catch(err => {
  console.error('MediaPipe init failed:', err);
  loadingScreen.querySelector('.loader-text').textContent = 'âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ×”×× ×•×¢. ×¨×¢× ×Ÿ ××ª ×”×“×£.';
});
</script>
</body>
</html>
